<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NFL – Game Props Recommendations</title>
  <style>
    :root{ --bg:#0a1020; --card:#0f1730; --muted:#c7d2fe; --text:#f8fafc; --br:#223055; --pill:#152046; --link:#93c5fd; --button-bg:#1b2339; --button-br:#2a3a63; --button-text:#e6edf7 }
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:var(--text)}
    .container{max-width:1000px;margin:20px auto;padding:0 16px}
    .nav{font-size:14px;margin-bottom:10px}
    .nav a{color:var(--link);text-decoration:none;margin-right:10px}
    .card{background:linear-gradient(180deg,var(--card),#0c1328);border:1px solid var(--br);border-radius:12px;padding:12px;box-shadow:0 10px 24px rgba(0,0,0,.35);margin-bottom:12px}
    .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 12px}
    .filters input, .filters select{background:var(--bg);color:var(--text);border:1px solid var(--br);border-radius:6px;padding:6px 8px}
    .row{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--br);border-radius:10px;padding:8px 10px;background:var(--pill);margin-top:6px}
    .muted{color:var(--muted)}
    .ev{color:#86efac}
    .edge{color:#facc15}
    .price{font-size:12px;margin-left:6px}
    .price .label{opacity:.7;margin-right:3px}
    .price .val{display:inline-block;border:1px solid var(--br);border-radius:8px;padding:2px 6px}
    .price .sel{background:#10315a}
    /* Ladder grouping */
    details.ladder{border:1px solid var(--br);border-radius:10px;background:var(--pill);margin-top:6px}
    details.ladder>summary{list-style:none;cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:8px 10px}
    details.ladder[open]>summary{border-bottom:1px solid var(--br)}
    details.ladder .ladder-rows{display:block}
    .tag{font-size:12px;opacity:.8;background:#1a2444;border:1px solid var(--br);border-radius:999px;padding:2px 8px;margin-left:8px}
  </style>
</head>
<body>
  <div class="container">
    <div class="nav"><a href="/">Cards</a> | <a href="/recommendations">Recommendations</a> | <a href="/props">Props</a> | <a href="/props/recommendations">Props Recs</a> | <a href="/reconciliation">Reconciliation</a> | <a href="/game-props/recommendations">Game Props Recs</a></div>
    <h1>Game Props Recommendations</h1>
    <form id="filters" class="filters">
      <label>Season <input type="number" id="season" placeholder="YYYY"></label>
      <label>Week <input type="number" id="week" placeholder="N"></label>
      <label>Game
        <select id="game"><option value="">All games</option></select>
      </label>
  <label><input type="checkbox" id="includeCore" checked> Include core markets</label>
      <label><input type="checkbox" id="asLadders" checked> Show as ladders</label>
      <label><input type="checkbox" id="hideMoneyline" checked> Hide moneyline</label>
      <button type="submit">Apply</button>
      <button type="button" id="reset">Reset</button>
    </form>
    <div id="status" class="muted">Loading…</div>
    <div id="list"></div>
  </div>
    {% include '_footer.html' %}
  <script>
    function qs(name){ const u=new URL(window.location); return u.searchParams.get(name) }
    function fmtNum(x){ if(x==null||isNaN(x)) return '—'; return Number(x).toFixed(2) }
    async function loadData(){
      const params = new URLSearchParams();
      const s = document.getElementById('season').value || qs('season');
      const w = document.getElementById('week').value || qs('week');
      const g = document.getElementById('game').value;
      const includeCore = document.getElementById('includeCore').checked;
      if(s) params.set('season', s); if(w) params.set('week', w);
      if(g){ const [home,away,ev] = g.split('|'); if(ev) params.set('event', ev); else { if(home) params.set('home_team', home); if(away) params.set('away_team', away);} }
      // derivatives_only=1 hides core; set to 0 when includeCore is checked
      params.set('derivatives_only', includeCore ? '0' : '1');
      params.set('all','1');
      const url = '/api/game-props/recommendations' + (params.toString()? ('?'+params.toString()):'');
      const res = await fetch(url, {cache:'no-store'}); const js = await res.json();
      if(!document.getElementById('season').value && js.season){ document.getElementById('season').value = js.season; }
      if(!document.getElementById('week').value && js.week){ document.getElementById('week').value = js.week; }
      renderGames(js.games||[]);
      renderList(js.data||[]);
      const n = Array.isArray(js.data)? js.data.length: 0; const gg = Array.isArray(js.games)? js.games.length: 0;
      document.getElementById('status').textContent = n? `${n} markets • ${gg} games` : (js.note || 'No game props yet.');
    }
    function renderGames(games){
      const sel = document.getElementById('game'); const cur = sel.value; sel.innerHTML = '<option value="">All games</option>';
      games.forEach(g=>{ const label = `${g.away_team||'?'} @ ${g.home_team||'?'}`; const val = `${g.home_team||''}|${g.away_team||''}|${g.event||''}`; const opt = document.createElement('option'); opt.value=val; opt.textContent=label; sel.appendChild(opt); });
      if(cur){ sel.value = cur } else if(sel.options.length>1){ sel.selectedIndex = 1 }
    }
    function renderList(items){
      const root = document.getElementById('list'); root.innerHTML='';
      const groups = new Map();
      for(const r of items){ const key = `${r.away_team||''}@${r.home_team||''}`; if(!groups.has(key)) groups.set(key, []); groups.get(key).push(r) }
      for(const [key, arr] of groups.entries()){
        const [away, home] = key.split('@');
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `<div style="font-weight:600;display:flex;align-items:center;justify-content:space-between">
          <div>${away} @ ${home}</div>
          <div class="muted" style="font-size:12px">${arr.length} rows</div>
        </div>`;
        const body = document.createElement('div');
        const asLadders = document.getElementById('asLadders').checked;
        const hideMoneyline = document.getElementById('hideMoneyline').checked;

        // Separate markets
        const ml = []; const totals = []; const spreads = []; const teamTotals = [];
        for(const r of arr){
          const mk = String(r.market_key||'').toLowerCase();
          if(mk==='moneyline') ml.push(r);
          else if(mk==='total' || mk==='alt_total') totals.push(r);
          else if(mk==='spread' || mk==='alt_spread') spreads.push(r);
          else if(mk==='team_total') teamTotals.push(r);
        }

        function addRow(r){
          const side = r.side || (r.team_side? r.team_side.toUpperCase(): '');
          const prices = [];
          if(r.price_home!=null) prices.push(`<span class=\"price\"><span class=\"label\">H</span><span class=\"val\">${r.price_home}</span></span>`);
          if(r.price_away!=null) prices.push(`<span class=\"price\"><span class=\"label\">A</span><span class=\"val\">${r.price_away}</span></span>`);
          if(r.over_price!=null) prices.push(`<span class=\"price\"><span class=\"label\">O</span><span class=\"val\">${r.over_price}</span></span>`);
          if(r.under_price!=null) prices.push(`<span class=\"price\"><span class=\"label\">U</span><span class=\"val\">${r.under_price}</span></span>`);
          const evp = (r.ev_pct!=null? r.ev_pct: (r.ev_units!=null? r.ev_units*100: null));
          const row = document.createElement('div'); row.className='row';
          row.innerHTML = `<div>${r.market_key||''} ${side? '• '+side: ''} ${r.line!=null? '• '+r.line: ''}</div>
                           <div><span class=\"edge\">Δ ${fmtNum(r.edge_pts)}</span> <span class=\"ev\">EV ${fmtNum(evp)}</span> ${prices.join(' ')}</div>`;
          return row;
        }

        function groupLadder(rows, makeKey, label){
          if(!rows.length) return;
          const by = new Map();
          for(const r of rows){ const k = makeKey(r); if(!by.has(k)) by.set(k, []); by.get(k).push(r) }
          for(const [k, rs] of by.entries()){
            // Sort ladder by line ascending for Over; for Under/away side, sort descending so it "steps"
            const isUnder = /under|away/i.test(k);
            rs.sort((a,b)=>{
              const la = (a.line==null? 0: Number(a.line));
              const lb = (b.line==null? 0: Number(b.line));
              return isUnder? (lb-la):(la-lb);
            });
            const evBest = rs.reduce((m,r)=>{ const v=(r.ev_pct!=null? r.ev_pct: (r.ev_units!=null? r.ev_units*100: -Infinity)); return Math.max(m, isFinite(v)? v:-Infinity) }, -Infinity);
            const det = document.createElement('details'); det.className='ladder';
            det.innerHTML = `<summary><div>${label} <span class=\"tag\">${k}</span></div><div class=\"muted\" style=\"font-size:12px\">${rs.length} rungs • best EV ${fmtNum(evBest)}</div></summary>`;
            const wrap = document.createElement('div'); wrap.className='ladder-rows';
            for(const r of rs){ wrap.appendChild(addRow(r)) }
            det.appendChild(wrap); body.appendChild(det);
          }
        }

        if(asLadders){
          if(!hideMoneyline && ml.length){
            const det = document.createElement('details'); det.className='ladder';
            det.innerHTML = `<summary><div>Moneyline</div><div class=\"muted\" style=\"font-size:12px\">${ml.length} options</div></summary>`;
            const wrap = document.createElement('div'); wrap.className='ladder-rows';
            // Group ML by side
            const by = new Map();
            for(const r of ml){ const k = String(r.side||'').toUpperCase(); if(!by.has(k)) by.set(k, []); by.get(k).push(r) }
            for(const [k, rs] of by.entries()){ rs.forEach(r=> wrap.appendChild(addRow(r))) }
            det.appendChild(wrap); body.appendChild(det);
          }
          groupLadder(totals, r=> String(r.side||'').toUpperCase(), 'Total');
          // Spread: group ladders by side (HOME/AWAY)
          groupLadder(spreads, r=> String(r.side||'').toUpperCase(), 'Spread');
          // Team Totals: group by team and side (HOME/AWAY + O/U)
          groupLadder(teamTotals, r=> `${String(r.team_side||'').toUpperCase()}-${String(r.side||'').toUpperCase()}`, 'Team Total');
        } else {
          // Flat list fallback
          const flat = [];
          if(!hideMoneyline) flat.push(...ml);
          flat.push(...totals, ...spreads, ...teamTotals);
          flat.sort((a,b)=> String(a.market_key||'').localeCompare(String(b.market_key||'')) || Number(a.line||0)-Number(b.line||0));
          for(const r of flat){ body.appendChild(addRow(r)) }
        }

        card.appendChild(body); root.appendChild(card);
      }
    }
    document.getElementById('filters').addEventListener('submit', (e)=>{ e.preventDefault(); loadData(); });
    document.getElementById('reset').addEventListener('click', ()=>{ document.getElementById('season').value=''; document.getElementById('week').value=''; document.getElementById('game').value=''; document.getElementById('includeCore').checked=true; document.getElementById('asLadders').checked=true; document.getElementById('hideMoneyline').checked=true; loadData(); });
    window.addEventListener('load', loadData);
  </script>
</body>
</html>
