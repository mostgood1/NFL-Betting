<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NFL – Props Recommendations</title>
  <style>
    :root{ --bg:#0a1020; --card:#0f1730; --muted:#c7d2fe; --text:#f8fafc; --br:#223055; --pill:#152046; --link:#93c5fd; --button-bg:#1b2339; --button-br:#2a3a63; --button-text:#e6edf7 }
    body.light{ --bg:#ffffff; --card:#f8fafc; --muted:#475569; --text:#0a0f1c; --br:#cbd5e1; --pill:#eef2f7; --link:#1e40af; --button-bg:#f1f5f9; --button-br:#94a3b8; --button-text:#0a0f1c }
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:var(--text)}
    .container{max-width:1100px;margin:20px auto;padding:0 16px}
    .nav{font-size:14px;margin-bottom:10px}
    .nav a{color:var(--link);text-decoration:none;margin-right:10px}
    .nav button.theme-toggle{background:var(--button-bg);color:var(--button-text);border:1px solid var(--button-br);border-radius:6px;padding:6px 10px;cursor:pointer}
  .card{background:linear-gradient(180deg,var(--card),#0c1328);border:1px solid var(--br);border-radius:12px;padding:12px;box-shadow:0 10px 24px rgba(0,0,0,.35)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .grid-mt{margin-top:10px}
    .muted{color:var(--muted)}
  .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 12px}
  .filters input, .filters select{background:var(--bg);color:var(--text);border:1px solid var(--br);border-radius:6px;padding:6px 8px}
  #season{width:90px}
  #week{width:70px}
    .player{display:flex;gap:10px;align-items:center}
    .logo{width:36px;height:36px;border-radius:50%;background:#111;border:1px solid var(--br);object-fit:cover}
    .plays{margin-top:6px}
  .play{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--br);border-radius:10px;padding:8px 10px;background:var(--pill);margin-top:6px}
    .badge{font-size:11px;border:1px solid var(--br);border-radius:999px;padding:2px 6px;margin-left:6px}
    .ev{color:#86efac}
    .edge{color:#facc15}
  .price{font-size:12px;margin-left:6px}
  .price .label{opacity:.7;margin-right:3px}
  .price .val{display:inline-block;border:1px solid var(--br);border-radius:8px;padding:2px 6px}
  .price .sel{background:#10315a}
    /* Ladder grouping */
  details.ladder{border:1px solid var(--br);border-radius:10px;background:var(--pill);margin-top:6px}
  details.ladder>summary{list-style:none;cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:8px 10px}
    details.ladder[open]>summary{border-bottom:1px solid var(--br)}
    details.ladder .ladder-rows{display:block}
  details.ladder .ladder-row{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-top:1px solid var(--br)}
    summary::-webkit-details-marker{display:none}
    @media (max-width:760px){ .grid{grid-template-columns:1fr} }
  </style>
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://a.espncdn.com">
  <link rel="dns-prefetch" href="https://a.espncdn.com">
  <meta name="color-scheme" content="dark light" />
</head>
<body>
  <div class="container">
    <div class="nav"><a href="/">Cards</a> | <a href="/recommendations">Recommendations</a> | <a href="/props">Props</a> | <a href="/props/recommendations">Props Recs</a> | <a href="/reconciliation">Reconciliation</a> | <button type="button" class="theme-toggle" id="themeToggle" title="Toggle light/dark">Toggle Theme</button></div>
    <h1>Props Recommendations</h1>
    <form id="filters" class="filters">
      <label>Season <input type="number" id="season" placeholder="YYYY"></label>
      <label>Week <input type="number" id="week" placeholder="N"></label>
      <label>Game
        <select id="game">
          <option value="">All games</option>
        </select>
      </label>
      <label><input type="checkbox" id="hideLadders"> Hide ladder plays</label>
      <button type="submit">Apply</button>
      <button type="button" id="reset">Reset</button>
    </form>

    <div id="status" class="muted">Loading…</div>
  <div id="cards" class="grid grid-mt"></div>
  </div>
  <script>
    // Theme toggle
    (function(){ try{ var body=document.body; var saved=localStorage.getItem('theme'); if(saved==='light'){ body.classList.add('light'); }
      var tbtn=document.getElementById('themeToggle'); if(tbtn){ tbtn.addEventListener('click', function(){ body.classList.toggle('light'); localStorage.setItem('theme', body.classList.contains('light')?'light':'dark'); }); }
    }catch(e){} })();
    function qs(name){ const u=new URL(window.location); return u.searchParams.get(name) }
    function fmtPct(x){ if(x==null||isNaN(x)) return ''; return (x).toFixed(1)+'%' }
    function fmtNum(x){ if(x==null||isNaN(x)) return '—'; return Number(x).toFixed(1) }
    function fmtMaybeNum(x){
      if(x==null||isNaN(x)) return null;
      const v = Number(x);
      if(v===0) return null; // hide zeros
      return v.toFixed(1);
    }

    function posKey(p){ const u=(p||'').toString().toUpperCase(); if(u.startsWith('QB')) return 'QB'; if(u.startsWith('RB')) return 'RB'; if(u.startsWith('WR')) return 'WR'; if(u.startsWith('TE')) return 'TE'; return 'UNK' }
    function buildProjText(it){
      const pr = it.projections || {}; const pk = posKey(it.position);
      const parts = [];
      if(pk==='QB' || pk==='UNK'){
        const pa=fmtMaybeNum(pr.pass_attempts); if(pa) parts.push(`att ${pa}`);
        const py=fmtMaybeNum(pr.pass_yards); if(py) parts.push(`pass ${py}`);
        const ptd=fmtMaybeNum(pr.pass_tds); if(ptd) parts.push(`pTD ${ptd}`);
        const ints=fmtMaybeNum(pr.interceptions); if(ints) parts.push(`INT ${ints}`);
        const ry=fmtMaybeNum(pr.rush_yards); if(ry) parts.push(`rush ${ry}`);
        const ra=fmtMaybeNum(pr.rush_attempts); if(ra) parts.push(`ra ${ra}`);
        const rr=fmtMaybeNum(pr.rush_rec_yards); if(rr) parts.push(`R+R ${rr}`);
        const pry=fmtMaybeNum(pr.pass_rush_yards); if(pry) parts.push(`P+R ${pry}`);
      }
      if(pk==='RB'){
        const ry=fmtMaybeNum(pr.rush_yards); if(ry) parts.push(`rush ${ry}`);
        const ra=fmtMaybeNum(pr.rush_attempts); if(ra) parts.push(`ra ${ra}`);
        const rtd=fmtMaybeNum(pr.rush_tds); if(rtd) parts.push(`rTD ${rtd}`);
        const recy=fmtMaybeNum(pr.rec_yards); if(recy) parts.push(`rec ${recy}`);
        const recs=fmtMaybeNum(pr.receptions); if(recs) parts.push(`recs ${recs}`);
        const rctd=fmtMaybeNum(pr.rec_tds); if(rctd) parts.push(`recTD ${rctd}`);
        const t=fmtMaybeNum(pr.targets); if(t) parts.push(`tgt ${t}`);
        const rr=fmtMaybeNum(pr.rush_rec_yards); if(rr) parts.push(`R+R ${rr}`);
      }
      if(pk==='WR' || pk==='TE'){
        const recy=fmtMaybeNum(pr.rec_yards); if(recy) parts.push(`rec ${recy}`);
        const recs=fmtMaybeNum(pr.receptions); if(recs) parts.push(`recs ${recs}`);
        const rctd=fmtMaybeNum(pr.rec_tds); if(rctd) parts.push(`recTD ${rctd}`);
        const t=fmtMaybeNum(pr.targets); if(t) parts.push(`tgt ${t}`);
      }
      // ATD shown for skill positions and QB if present
      if(['QB','RB','WR','TE','UNK'].includes(pk)){
        const atd = pr.any_td_prob!=null && !isNaN(pr.any_td_prob) ? (pr.any_td_prob*100) : null;
        const atdS = (atd!=null && !isNaN(atd) && atd!==0) ? atd.toFixed(1)+'%' : null; if(atdS) parts.push(`ATD ${atdS}`);
      }
      if(!parts.length) return '';
      return 'Proj: ' + parts.join(' • ');
    }

    async function loadData(){
      const params = new URLSearchParams();
      const s = document.getElementById('season').value || qs('season');
      const w = document.getElementById('week').value || qs('week');
      const g = document.getElementById('game').value;
      if(s) params.set('season', s); if(w) params.set('week', w);
      if(g){
        const [home,away,ev] = g.split('|');
        if(ev) params.set('event', ev); else { if(home) params.set('home_team', home); if(away) params.set('away_team', away); }
      }
      const url = '/api/props/recommendations' + (params.toString()? ('?'+params.toString()):'');
      const res = await fetch(url, {cache:'no-store'});
      const js = await res.json();
      // Default inputs to current season/week if not set
      if(!document.getElementById('season').value && js.season){
        document.getElementById('season').value = js.season;
      }
      if(!document.getElementById('week').value && js.week){
        document.getElementById('week').value = js.week;
      }
      renderGames(js.games||[]);
      renderCards(js.data||[]);
      document.getElementById('status').textContent = js.rows? `${js.rows} players` : (js.note || 'No props recommendations yet.');
    }

    function renderGames(games){
      const sel = document.getElementById('game');
      const cur = sel.value;
      sel.innerHTML = '<option value="">All games</option>';
      games.forEach(g=>{
        const label = g.event || `${g.away_team||'?'} @ ${g.home_team||'?'}`;
        const val = `${g.home_team||''}|${g.away_team||''}|${g.event||''}`;
        const opt = document.createElement('option');
        opt.value = val; opt.textContent = label; sel.appendChild(opt);
      });
      if(cur) {
        sel.value = cur;
      } else if(sel.options.length > 1){
        // Default to first game for current week if none selected
        sel.selectedIndex = 1;
      }
    }

    function renderCards(items){
      const root = document.getElementById('cards');
      root.innerHTML = '';
      const hideLadders = document.getElementById('hideLadders').checked;
      items.forEach(it=>{
        const div = document.createElement('div');
        div.className = 'card';
        const teamLogo = it.team_logo? `<img class="logo" src="${it.team_logo}" alt="">` : '';
        const projText = buildProjText(it);
  const away = it.away_team||'';
  const home = it.home_team||'';
  // Prefer the book event string when present to avoid duplicate labels
  const matchup = it.event || ((away&&home)? `${away} @ ${home}` : (away||home||''));
        div.innerHTML = `
          <div class="player">
            ${teamLogo}
            <div>
              <div style="font-weight:600">${it.player||''} <span class="muted" style="font-weight:400">${(it.position&&it.team)? `${it.position} • ${it.team}` : ((it.position||it.team)||'')}</span></div>
              <div class="muted" style="font-size:12px">${matchup}</div>
              ${projText? `<div class=\"muted\" style=\"font-size:12px;margin-top:2px\">${projText}</div>` : ''}
            </div>
          </div>
          <div class="plays"></div>
        `;
        const plays = div.querySelector('.plays');
        const allPlays = (it.plays||[]);
        // Separate ladder vs non-ladder
        const basePlays = [];
        const ladderGroups = new Map(); // market -> plays[]
        for(const p of allPlays){
          if(p && p.is_ladder===true){
            const mk = (p.market||'').toString();
            if(!ladderGroups.has(mk)) ladderGroups.set(mk, []);
            ladderGroups.get(mk).push(p);
          } else {
            basePlays.push(p);
          }
        }
        // Render non-ladder plays
        basePlays.forEach(p=>{
          const ev = (p.ev_pct!=null)? `<span class="ev">EV ${fmtNum(p.ev_pct)}</span>`: '';
          const edge = (p.edge!=null)? `<span class="edge">Δ ${fmtNum(p.edge)}</span>`: '';
          const o = p.over_price!=null? Number(p.over_price): null;
          const u = p.under_price!=null? Number(p.under_price): null;
          const line = (p.line!=null? p.line : null);
          const row = document.createElement('div');
          row.className='play';
          row.innerHTML = `
            <div>${p.market||''} • ${p.side||''}${line!=null? ' '+line: ''}</div>
            <div>${edge} ${ev}
              <span class=\"price\"><span class=\"label\">O</span><span class=\"val ${p.side==='Over'?'sel':''}\">${o!=null? o: ''}</span></span>
              <span class=\"price\"><span class=\"label\">U</span><span class=\"val ${p.side==='Under'?'sel':''}\">${u!=null? u: ''}</span></span>
            </div>
          `;
          plays.appendChild(row);
        });
        // Render ladder groups (skip entirely if hidden)
        if(!hideLadders){
          for(const [market, arr] of ladderGroups.entries()){
            // Sort ladder lines by numeric line asc
            arr.sort((a,b)=>{
              const la = (a.line!=null && !isNaN(a.line))? Number(a.line): Number.POSITIVE_INFINITY;
              const lb = (b.line!=null && !isNaN(b.line))? Number(b.line): Number.POSITIVE_INFINITY;
              return la - lb;
            });
            const count = arr.length;
            // Compute best edge/ev for summary
            const bestEdge = arr.reduce((m,p)=> (p.edge!=null && (!isNaN(p.edge)) && (m==null || Math.abs(p.edge)>Math.abs(m))? p.edge: m), null);
            const anyEv = arr.find(p=> p.ev_pct!=null && !isNaN(p.ev_pct));
            const evStr = anyEv? `EV ${fmtNum(anyEv.ev_pct)}`: '';
            const details = document.createElement('details');
            details.className = 'ladder';
            const edgeStr = (bestEdge!=null)? `<span class="edge">Δ ${fmtNum(bestEdge)}</span>`: '';
            details.innerHTML = `
              <summary>
                <div>Ladder: ${market} <span class="badge">${count} lines</span></div>
                <div>${edgeStr} ${evStr}</div>
              </summary>
              <div class="ladder-rows"></div>
            `;
            const rowsRoot = details.querySelector('.ladder-rows');
            arr.forEach(p=>{
              const ev = (p.ev_pct!=null)? `<span class=\"ev\">EV ${fmtNum(p.ev_pct)}</span>`: '';
              const edge = (p.edge!=null)? `<span class=\"edge\">Δ ${fmtNum(p.edge)}</span>`: '';
              const o = p.over_price!=null? Number(p.over_price): null;
              const u = p.under_price!=null? Number(p.under_price): null;
              const line = (p.line!=null? p.line : null);
              const row = document.createElement('div');
              row.className='ladder-row';
              row.innerHTML = `
                <div>${p.side||''}${line!=null? ' '+line: ''}</div>
                <div>${edge} ${ev}
                  <span class=\"price\"><span class=\"label\">O</span><span class=\"val ${p.side==='Over'?'sel':''}\">${o!=null? o: ''}</span></span>
                  <span class=\"price\"><span class=\"label\">U</span><span class=\"val ${p.side==='Under'?'sel':''}\">${u!=null? u: ''}</span></span>
                </div>
              `;
              rowsRoot.appendChild(row);
            });
            plays.appendChild(details);
          }
        }
        root.appendChild(div);
      });
    }

    document.getElementById('filters').addEventListener('submit', (e)=>{ e.preventDefault(); loadData(); });
    document.getElementById('hideLadders').addEventListener('change', ()=>{ loadData(); });
    document.getElementById('reset').addEventListener('click', ()=>{ document.getElementById('season').value=''; document.getElementById('week').value=''; document.getElementById('game').value=''; loadData(); });
    window.addEventListener('load', loadData);
  </script>
</body>
</html>
