<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NFL – Props Recommendations</title>
  <style>
    :root{ --bg:#0a1020; --card:#0f1730; --muted:#c7d2fe; --text:#f8fafc; --br:#223055; --pill:#152046; --link:#93c5fd; --button-bg:#1b2339; --button-br:#2a3a63; --button-text:#e6edf7; --evbg:#113a34; --evfg:#a7f3d0; --rec-over-bg:#0f3d2b; --rec-over-br:#167a5b; --rec-over-fg:#c7f9e5; --rec-under-bg:#3d1220; --rec-under-br:#7f1d1d; --rec-under-fg:#fde2e2 }
    body.light{ --bg:#ffffff; --card:#f8fafc; --muted:#475569; --text:#0a0f1c; --br:#cbd5e1; --pill:#eef2f7; --link:#1e40af; --button-bg:#f1f5f9; --button-br:#94a3b8; --button-text:#0a0f1c; --evbg:#dcfce7; --evfg:#065f46; --rec-over-bg:#d1fae5; --rec-over-br:#10b981; --rec-over-fg:#065f46; --rec-under-bg:#fee2e2; --rec-under-br:#ef4444; --rec-under-fg:#7f1d1d }
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:var(--text)}
    .container{max-width:1100px;margin:20px auto;padding:0 16px}
    .nav{font-size:14px;margin-bottom:10px}
    .nav a{color:var(--link);text-decoration:none;margin-right:10px}
    .nav button.theme-toggle{background:var(--button-bg);color:var(--button-text);border:1px solid var(--button-br);border-radius:6px;padding:6px 10px;cursor:pointer}
  .card{background:linear-gradient(180deg,var(--card),#0c1328);border:1px solid var(--br);border-radius:12px;padding:12px;box-shadow:0 10px 24px rgba(0,0,0,.35)}
  .card-header{position:relative;display:flex;gap:10px;align-items:center}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .grid-mt{margin-top:10px}
    .muted{color:var(--muted)}
  .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 12px}
  .filters input, .filters select{background:var(--bg);color:var(--text);border:1px solid var(--br);border-radius:6px;padding:6px 8px}
  #season{width:90px}
  #week{width:70px}
  .player{display:flex;gap:10px;align-items:center}
  .logo{width:36px;height:36px;border-radius:50%;background:#111;border:1px solid var(--br);object-fit:cover}
  .player-photo{width:48px;height:48px;border-radius:50%;background:#111;border:1px solid var(--br);object-fit:cover}
  .team-logo-top{position:absolute;right:8px;top:8px;width:32px;height:32px;border-radius:50%;background:#111;border:1px solid var(--br);object-fit:cover}
    .plays{margin-top:6px}
  .play{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--br);border-radius:10px;padding:8px 10px;background:var(--pill);margin-top:6px}
  .badge{font-size:11px;border:1px solid var(--br);border-radius:999px;padding:2px 6px;margin-left:6px}
  .ev{display:inline-block;background:var(--evbg);color:var(--evfg);border:1px solid rgba(12, 148, 106, .35);border-radius:999px;padding:2px 6px;font-weight:600}
    .edge{color:#facc15}
  .price{font-size:12px;margin-left:6px}
  .price .label{opacity:.7;margin-right:3px}
  .price .val{display:inline-block;border:1px solid var(--br);border-radius:8px;padding:2px 6px}
  .price .sel{background:#10315a}
  /* Recommended side coloring */
  .price .val.over-rec{ background: var(--rec-over-bg); color: var(--rec-over-fg); border-color: var(--rec-over-br) }
  .price .val.under-rec{ background: var(--rec-under-bg); color: var(--rec-under-fg); border-color: var(--rec-under-br) }
  .price .label.over-rec{ color: var(--rec-over-fg) }
  .price .label.under-rec{ color: var(--rec-under-fg) }
  /* Row accents for recommended side */
  .play.over-row{ border-color: var(--rec-over-br) }
  .play.under-row{ border-color: var(--rec-under-br) }
  .ladder-row.over-row{ border-left: 3px solid var(--rec-over-br) }
  .ladder-row.under-row{ border-left: 3px solid var(--rec-under-br) }
    /* Ladder grouping */
  details.ladder{border:1px solid var(--br);border-radius:10px;background:var(--pill);margin-top:6px}
  details.ladder>summary{list-style:none;cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:8px 10px}
    details.ladder[open]>summary{border-bottom:1px solid var(--br)}
    details.ladder .ladder-rows{display:block}
  details.ladder .ladder-row{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-top:1px solid var(--br)}
    summary::-webkit-details-marker{display:none}
    @media (max-width:760px){ .grid{grid-template-columns:1fr} }
  </style>
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://a.espncdn.com">
  <link rel="dns-prefetch" href="https://a.espncdn.com">
  <meta name="color-scheme" content="dark light" />
</head>
<body>
  <div class="container">
  <div class="nav"><a href="/">Cards</a> | <a href="/recommendations">Recommendations</a> | <a href="/props">Props</a> | <a href="/props/recommendations">Props Recs</a> | <a href="/reconciliation">Reconciliation</a> | <a href="/game-props/recommendations">Game Props Recs</a> | <button type="button" class="theme-toggle" id="themeToggle" title="Toggle light/dark">Toggle Theme</button></div>
    <h1>Props Recommendations</h1>
    <form id="filters" class="filters">
      <label>Season <input type="number" id="season" placeholder="YYYY"></label>
      <label>Week <input type="number" id="week" placeholder="N"></label>
      <label>Game
        <select id="game">
          <option value="">All games</option>
        </select>
      </label>
      <label>Market
        <select id="marketFilter">
          <option value="">All markets</option>
        </select>
      </label>
      <label title="Only show plays with EV% computed"><input type="checkbox" id="onlyEV"> Only EV</label>
      <label title="Minimum EV% (e.g., 1.5)">Min EV% <input type="number" id="minEV" step="0.1" style="width:80px" placeholder="0.0"></label>
      <label title="Quick filter to EV ≥ 2%"><input type="checkbox" id="topEV"> Top EV only</label>
      <label>Sort By
        <select id="sortBy">
          <option value="ev_desc">EV desc</option>
          <option value="edge_desc">Edge desc</option>
        </select>
      </label>
      <label><input type="checkbox" id="hideLadders"> Hide ladder plays</label>
      <button type="submit">Apply</button>
      <button type="button" id="reset">Reset</button>
    </form>

    <div id="status" class="muted">Loading…</div>
  <div id="cards" class="grid grid-mt"></div>
  </div>
  <script>
    // Keep last data for client-side filtering without refetching
    let LAST_DATA = [];
    function mkKey(s){ if(!s) return ''; const d=String(s).trim().toLowerCase();
      const map={
        'receiving yards':'rec_yards','receptions':'receptions','rushing yards':'rush_yards','passing yards':'pass_yards',
        'passing tds':'pass_tds','pass tds':'pass_tds','pass touchdowns':'pass_tds',
        'passing attempts':'pass_attempts','pass attempts':'pass_attempts','rushing attempts':'rush_attempts','rush attempts':'rush_attempts',
        'interceptions':'interceptions','interceptions thrown':'interceptions',
        'rush+rec yards':'rush_rec_yards','rushing + receiving yards':'rush_rec_yards','rush + rec yards':'rush_rec_yards',
        'pass+rush yards':'pass_rush_yards','pass + rush yards':'pass_rush_yards','passing + rushing yards':'pass_rush_yards',
        'targets':'targets','2+ touchdowns':'multi_tds','anytime td':'any_td','any time td':'any_td'
      };
      return map[d] || d;
    }
    function mkLabel(key){ const map={
      'rec_yards':'Receiving Yards','receptions':'Receptions','rush_yards':'Rushing Yards','pass_yards':'Passing Yards',
      'any_td':'Any Time TD','pass_tds':'Passing TDs','interceptions':'Interceptions','rush_attempts':'Rush Attempts','pass_attempts':'Pass Attempts',
      'rush_rec_yards':'Rushing+Receiving Yards','pass_rush_yards':'Passing+Rushing Yards','targets':'Targets','multi_tds':'2+ Touchdowns'
    }; return map[key] || (key? key.replace(/\b\w/g,c=>c.toUpperCase()).replace(/_/g,' '): ''); }
    function collectMarkets(data){ const set=new Set(); (data||[]).forEach(it=> (it.plays||[]).forEach(p=>{ const k=mkKey(p.market); if(k) set.add(k); }));
      // Order common markets first
      const order=['receptions','rec_yards','rush_yards','pass_yards','any_td','pass_tds','interceptions','rush_attempts','pass_attempts','rush_rec_yards','pass_rush_yards','targets','multi_tds'];
      const rest=[...set].filter(k=> !order.includes(k)).sort();
      return [...order.filter(k=> set.has(k)), ...rest];
    }
    function renderMarketFilter(data){ const sel=document.getElementById('marketFilter'); if(!sel) return; const cur=sel.value; const keys=collectMarkets(data);
      sel.innerHTML = '<option value="">All markets</option>' + keys.map(k=> `<option value="${k}">${mkLabel(k)}</option>`).join('');
      if(cur && [...sel.options].some(o=> o.value===cur)) sel.value=cur;
    }
    // Theme toggle
    (function(){ try{ var body=document.body; var saved=localStorage.getItem('theme'); if(saved==='light'){ body.classList.add('light'); }
      var tbtn=document.getElementById('themeToggle'); if(tbtn){ tbtn.addEventListener('click', function(){ body.classList.toggle('light'); localStorage.setItem('theme', body.classList.contains('light')?'light':'dark'); }); }
    }catch(e){} })();
    function qs(name){ const u=new URL(window.location); return u.searchParams.get(name) }
  function fmtPct(x){ if(x==null||isNaN(x)) return ''; return (x).toFixed(1)+'%' }
  const EV_TOP_THRESHOLD = 2.0; // percent
    function fmtNum(x){ if(x==null||isNaN(x)) return '—'; return Number(x).toFixed(1) }
    function fmtMaybeNum(x){
      if(x==null||isNaN(x)) return null;
      const v = Number(x);
      if(v===0) return null; // hide zeros
      return v.toFixed(1);
    }

    function posKey(p){ const u=(p||'').toString().toUpperCase(); if(u.startsWith('QB')) return 'QB'; if(u.startsWith('RB')) return 'RB'; if(u.startsWith('WR')) return 'WR'; if(u.startsWith('TE')) return 'TE'; return 'UNK' }
    function buildProjText(it){
      const pr = it.projections || {}; const pk = posKey(it.position);
      const parts = [];
      if(pk==='QB' || pk==='UNK'){
        const pa=fmtMaybeNum(pr.pass_attempts); if(pa) parts.push(`att ${pa}`);
        const py=fmtMaybeNum(pr.pass_yards); if(py) parts.push(`pass ${py}`);
        const ptd=fmtMaybeNum(pr.pass_tds); if(ptd) parts.push(`Passing TDs ${ptd}`);
        const ints=fmtMaybeNum(pr.interceptions); if(ints) parts.push(`INT ${ints}`);
        const ry=fmtMaybeNum(pr.rush_yards); if(ry) parts.push(`rush ${ry}`);
        const ra=fmtMaybeNum(pr.rush_attempts); if(ra) parts.push(`ra ${ra}`);
        const rr=fmtMaybeNum(pr.rush_rec_yards); if(rr) parts.push(`R+R ${rr}`);
        const pry=fmtMaybeNum(pr.pass_rush_yards); if(pry) parts.push(`P+R ${pry}`);
      }
      if(pk==='RB'){
        const ry=fmtMaybeNum(pr.rush_yards); if(ry) parts.push(`rush ${ry}`);
        const ra=fmtMaybeNum(pr.rush_attempts); if(ra) parts.push(`ra ${ra}`);
        const recy=fmtMaybeNum(pr.rec_yards); if(recy) parts.push(`rec ${recy}`);
        const recs=fmtMaybeNum(pr.receptions); if(recs) parts.push(`recs ${recs}`);
        const t=fmtMaybeNum(pr.targets); if(t) parts.push(`tgt ${t}`);
        const rr=fmtMaybeNum(pr.rush_rec_yards); if(rr) parts.push(`R+R ${rr}`);
      }
      if(pk==='WR' || pk==='TE'){
        const recy=fmtMaybeNum(pr.rec_yards); if(recy) parts.push(`rec ${recy}`);
        const recs=fmtMaybeNum(pr.receptions); if(recs) parts.push(`recs ${recs}`);
        const t=fmtMaybeNum(pr.targets); if(t) parts.push(`tgt ${t}`);
      }
      // ATD shown for skill positions and QB if present
      if(['QB','RB','WR','TE','UNK'].includes(pk)){
        const atd = pr.any_td_prob!=null && !isNaN(pr.any_td_prob) ? (pr.any_td_prob*100) : null;
        const atdS = (atd!=null && !isNaN(atd) && atd!==0) ? atd.toFixed(1)+'%' : null; if(atdS) parts.push(`ATD ${atdS}`);
      }
      if(!parts.length) return '';
      return 'Proj: ' + parts.join(' • ');
    }

    // Team logo helpers: derive ESPN logo URL when backend didn't attach team_logo
    const TEAM_ABBR_MAP = (function(){
      const m = new Map();
      function a(keys, abbr){ keys.forEach(k=> m.set(String(k).toUpperCase(), abbr)); }
      a(['Arizona Cardinals','Cardinals','ARI'], 'ARI');
      a(['Atlanta Falcons','Falcons','ATL'], 'ATL');
      a(['Baltimore Ravens','Ravens','BAL'], 'BAL');
      a(['Buffalo Bills','Bills','BUF'], 'BUF');
      a(['Carolina Panthers','Panthers','CAR'], 'CAR');
      a(['Chicago Bears','Bears','CHI'], 'CHI');
      a(['Cincinnati Bengals','Bengals','CIN'], 'CIN');
      a(['Cleveland Browns','Browns','CLE'], 'CLE');
      a(['Dallas Cowboys','Cowboys','DAL'], 'DAL');
      a(['Denver Broncos','Broncos','DEN'], 'DEN');
      a(['Detroit Lions','Lions','DET'], 'DET');
      a(['Green Bay Packers','Packers','GB','GBP','GNB'], 'GB');
      a(['Houston Texans','Texans','HOU'], 'HOU');
      a(['Indianapolis Colts','Colts','IND'], 'IND');
      a(['Jacksonville Jaguars','Jaguars','JAX','JAC'], 'JAX');
      a(['Kansas City Chiefs','Chiefs','KC','KCC'], 'KC');
      a(['Las Vegas Raiders','Raiders','LV','LVR','OAK'], 'LV');
      a(['Los Angeles Chargers','Chargers','LAC','SD'], 'LAC');
      a(['Los Angeles Rams','Rams','LAR','STL'], 'LAR');
      a(['Miami Dolphins','Dolphins','MIA'], 'MIA');
      a(['Minnesota Vikings','Vikings','MIN'], 'MIN');
      a(['New England Patriots','Patriots','NE','NWE'], 'NE');
      a(['New Orleans Saints','Saints','NO','NOR'], 'NO');
      a(['New York Giants','Giants','NYG'], 'NYG');
      a(['New York Jets','Jets','NYJ'], 'NYJ');
      a(['Philadelphia Eagles','Eagles','PHI'], 'PHI');
      a(['Pittsburgh Steelers','Steelers','PIT'], 'PIT');
      a(['Seattle Seahawks','Seahawks','SEA'], 'SEA');
      a(['San Francisco 49ers','49ers','SF','SFO','SFN'], 'SF');
      a(['Tampa Bay Buccaneers','Buccaneers','Bucs','TB','TAM'], 'TB');
      a(['Tennessee Titans','Titans','TEN'], 'TEN');
      a(['Washington Commanders','Commanders','WAS','WSH'], 'WAS');
      return m;
    })();
    function teamAbbr(team){ if(!team) return null; const key=String(team).toUpperCase().trim(); return TEAM_ABBR_MAP.get(key) || key; }
    function espnTeamLogo(abbr){ if(!abbr) return null; const up=String(abbr).toUpperCase(); const espnMap={ 'WAS':'wsh' }; const code=(espnMap[up]||up).toLowerCase(); return `https://a.espncdn.com/i/teamlogos/nfl/500/${code}.png`; }

    function syncControlsFromUrl(){
      try{
        const u = new URL(window.location);
        const g = u.searchParams.get('game');
        const all = u.searchParams.get('all');
        const mf = u.searchParams.get('market');
        const onlyEV = u.searchParams.get('onlyEV');
        const minEV = u.searchParams.get('minEV');
        const sortBy = u.searchParams.get('sortBy');
        const hideL = u.searchParams.get('hideLadders');
        const topEV = u.searchParams.get('topEV');
        if(mf) document.getElementById('marketFilter').value = mf;
        if(onlyEV){ document.getElementById('onlyEV').checked = ['1','true','yes','y'].includes(onlyEV.toLowerCase()); }
        if(minEV){ document.getElementById('minEV').value = minEV; }
        if(sortBy){ document.getElementById('sortBy').value = sortBy; }
        if(hideL){ document.getElementById('hideLadders').checked = ['1','true','yes','y'].includes(hideL.toLowerCase()); }
        if(topEV){ document.getElementById('topEV').checked = ['1','true','yes','y'].includes(topEV.toLowerCase()); }
      }catch(e){}
    }
    function updateUrlFromControls(extraParams){
      try{
        const u = new URL(window.location);
        const s = document.getElementById('season').value || qs('season');
        const w = document.getElementById('week').value || qs('week');
        const g = document.getElementById('game').value;
        const mf = document.getElementById('marketFilter').value;
        const onlyEV = document.getElementById('onlyEV').checked;
        const minEV = document.getElementById('minEV').value;
        const sortBy = document.getElementById('sortBy').value;
        const hideL = document.getElementById('hideLadders').checked;
        const topEV = document.getElementById('topEV').checked;
        u.searchParams.delete('event'); u.searchParams.delete('home_team'); u.searchParams.delete('away_team');
        if(s) u.searchParams.set('season', s); else u.searchParams.delete('season');
        if(w) u.searchParams.set('week', w); else u.searchParams.delete('week');
        if(g){
          // carry event/home/away inside game value as we do now
          u.searchParams.set('game', g);
          u.searchParams.delete('all');
        } else {
          u.searchParams.delete('game');
          u.searchParams.set('all','1');
        }
        if(mf) u.searchParams.set('market', mf); else u.searchParams.delete('market');
        if(onlyEV) u.searchParams.set('onlyEV','1'); else u.searchParams.delete('onlyEV');
        if(minEV) u.searchParams.set('minEV', minEV); else u.searchParams.delete('minEV');
        if(sortBy) u.searchParams.set('sortBy', sortBy); else u.searchParams.delete('sortBy');
        if(hideL) u.searchParams.set('hideLadders','1'); else u.searchParams.delete('hideLadders');
        if(topEV) u.searchParams.set('topEV','1'); else u.searchParams.delete('topEV');
        if(extraParams){ Object.entries(extraParams).forEach(([k,v])=>{ if(v==null || v==='') u.searchParams.delete(k); else u.searchParams.set(k,String(v)); }); }
        window.history.replaceState({}, '', u.toString());
      }catch(e){}
    }
    async function loadData(){
      const params = new URLSearchParams();
      const s = document.getElementById('season').value || qs('season');
      const w = document.getElementById('week').value || qs('week');
      const g = document.getElementById('game').value;
      if(s) params.set('season', s); if(w) params.set('week', w);
      if(g){
        const [home,away,ev] = g.split('|');
        if(ev) params.set('event', ev); else { if(home) params.set('home_team', home); if(away) params.set('away_team', away); }
      }
  // If "All games" is selected (empty value), request all games explicitly to avoid API default narrowing
  if(!g){ params.set('all','1'); }
      // Also reflect current UI state into the page URL for bookmarking
      updateUrlFromControls();
  const url = '/api/props/recommendations' + (params.toString()? ('?'+params.toString()):'');
      const res = await fetch(url, {cache:'no-store'});
      const js = await res.json();
      // Default inputs to current season/week if not set
      if(!document.getElementById('season').value && js.season){
        document.getElementById('season').value = js.season;
      }
      if(!document.getElementById('week').value && js.week){
        document.getElementById('week').value = js.week;
      }
  renderGames(js.games||[]);
  LAST_DATA = js.data || [];
  renderMarketFilter(LAST_DATA);
  renderCards(LAST_DATA);
      document.getElementById('status').textContent = js.rows? `${js.rows} players` : (js.note || 'No props recommendations yet.');
    }

    function renderGames(games){
      const sel = document.getElementById('game');
      const cur = sel.value;
      sel.innerHTML = '<option value="">All games</option>';
      games.forEach(g=>{
        // Canonical label: Away @ Home to avoid duplicate variants
        const label = `${g.away_team||'?'} @ ${g.home_team||'?'}`;
        const val = `${g.home_team||''}|${g.away_team||''}|${g.event||''}`;
        const opt = document.createElement('option');
        opt.value = val; opt.textContent = label; sel.appendChild(opt);
      });
      if(cur) {
        sel.value = cur;
      } else if(sel.options.length > 1){
        // Default to first game unless URL explicitly requested all=1
        const allParam = (qs('all')||'').toString().toLowerCase();
        const wantAll = ['1','true','yes','y'].includes(allParam);
        if(!wantAll){ sel.selectedIndex = 1; }
      }
    }

    function renderCards(items){
      const root = document.getElementById('cards');
      root.innerHTML = '';
      const hideLadders = document.getElementById('hideLadders').checked;
      const marketFilter = document.getElementById('marketFilter').value || '';
      const onlyEV = document.getElementById('onlyEV').checked;
      const topEV = document.getElementById('topEV').checked;
      const minEV = (function(){
        if(topEV) return EV_TOP_THRESHOLD;
        const v = parseFloat(document.getElementById('minEV').value);
        return isNaN(v)? null : v;
      })();
      const sortBy = document.getElementById('sortBy').value || 'ev_desc';
      function passes(p){
        if(!p) return false;
        if(marketFilter){ if(mkKey(p.market)!==marketFilter) return false; }
        const ev = (p.ev_pct!=null && !isNaN(p.ev_pct)) ? Number(p.ev_pct) : null;
        if(onlyEV && (ev==null)) return false;
        if(minEV!=null && (ev==null || ev < minEV)) return false;
        return true;
      }
      function sortPlays(arr){
        if(sortBy==='edge_desc'){
          arr.sort((a,b)=>{
            const ea = (a.edge!=null && !isNaN(a.edge))? Math.abs(Number(a.edge)) : -1e9;
            const eb = (b.edge!=null && !isNaN(b.edge))? Math.abs(Number(b.edge)) : -1e9;
            if(eb!==ea) return eb-ea;
            const av = (a.ev_pct!=null && !isNaN(a.ev_pct))? Number(a.ev_pct) : -1e9;
            const bv = (b.ev_pct!=null && !isNaN(b.ev_pct))? Number(b.ev_pct) : -1e9;
            return bv-av;
          });
        } else {
          // ev_desc default
          arr.sort((a,b)=>{
            const av = (a.ev_pct!=null && !isNaN(a.ev_pct))? Number(a.ev_pct) : -1e9;
            const bv = (b.ev_pct!=null && !isNaN(b.ev_pct))? Number(b.ev_pct) : -1e9;
            if(bv!==av) return bv-av;
            const ea = (a.edge!=null && !isNaN(a.edge))? Math.abs(Number(a.edge)) : -1e9;
            const eb = (b.edge!=null && !isNaN(b.edge))? Math.abs(Number(b.edge)) : -1e9;
            return eb-ea;
          });
        }
      }
      items.forEach(it=>{
        const div = document.createElement('div');
        div.className = 'card';
        const derivedLogo = (!it.team_logo && it.team) ? espnTeamLogo(teamAbbr(it.team)) : null;
        const teamLogoUrl = it.team_logo || derivedLogo || '';
        const teamLogoTop = teamLogoUrl ? `<img class=\"team-logo-top\" src=\"${teamLogoUrl}\" alt=\"\" onerror=\"this.style.display='none'\">` : '';
        const projText = buildProjText(it);
  const away = it.away_team||'';
  const home = it.home_team||'';
  // Canonical label: always render as Away @ Home
  const matchup = (away&&home)? `${away} @ ${home}` : (away||home||'');
        const playerName = it.player || 'Player';
        const playerPhoto = it.player_photo || '';
        const photoUrl = playerPhoto || `https://ui-avatars.com/api/?name=${encodeURIComponent(playerName)}&background=0b1225&color=fff&size=96&format=png`;
        div.innerHTML = `
          <div class=\"card-header\"> 
            <img class=\"player-photo\" src=\"${photoUrl}\" alt=\"\" onerror=\"this.style.display='none'\"> 
            <div class=\"player\"> 
              <div> 
                <div style=\"font-weight:600\">${it.player||''} <span class=\"muted\" style=\"font-weight:400\">${(it.position&&it.team)? `${it.position} • ${it.team}` : ((it.position||it.team)||'')}</span></div> 
                <div class=\"muted\" style=\"font-size:12px\">${matchup}</div> 
                ${projText? `<div class=\\\"muted\\\" style=\\\"font-size:12px;margin-top:2px\\\">${projText}</div>` : ''} 
              </div> 
            </div> 
            ${teamLogoTop}
          </div>
          <div class="plays"></div>
        `;
        const plays = div.querySelector('.plays');
        const allPlays = (it.plays||[]);
        // Separate ladder vs non-ladder, applying filters
        const basePlays = [];
        const ladderGroups = new Map(); // market -> plays[]
        for(const p of allPlays){
          if(!passes(p)) continue;
          if(p && p.is_ladder===true){
            const mk = (p.market||'').toString();
            if(!ladderGroups.has(mk)) ladderGroups.set(mk, []);
            ladderGroups.get(mk).push(p);
          } else {
            basePlays.push(p);
          }
        }
        // Sort and render non-ladder plays
        sortPlays(basePlays);
        basePlays.forEach(p=>{
          const evNum = (p.ev_pct!=null && !isNaN(p.ev_pct)) ? `${fmtNum(p.ev_pct)}%` : null;
          const edge = (p.edge!=null)? `<span class="edge">Δ ${fmtNum(p.edge)}</span>`: '';
          const o = p.over_price!=null? Number(p.over_price): null;
          const u = p.under_price!=null? Number(p.under_price): null;
          const line = (p.line!=null? p.line : null);
          const row = document.createElement('div');
          row.className='play ' + (p.side==='Over'?'over-row': (p.side==='Under'?'under-row':''));
          const sideIcon = p.side==='Over'? '↑' : (p.side==='Under'? '↓' : '');
          row.innerHTML = `
            <div>${sideIcon? `<span title=\"${p.side}\">${sideIcon}</span> `:''}${p.market||''} • ${p.side||''}${line!=null? ' '+line: ''}</div>
            <div>${edge} ${evNum? `<span class=\"ev\">EV ${evNum}</span>`: ''}
              <span class=\"price\"><span class=\"label ${p.side==='Over'?'over-rec':''}\">O</span><span class=\"val ${p.side==='Over'?'sel over-rec':''}\">${o!=null? o: ''}</span></span>
              <span class=\"price\"><span class=\"label ${p.side==='Under'?'under-rec':''}\">U</span><span class=\"val ${p.side==='Under'?'sel under-rec':''}\">${u!=null? u: ''}</span></span>
            </div>
          `;
          plays.appendChild(row);
        });
        // Render ladder groups (skip entirely if hidden)
        if(!hideLadders){
          for(const [market, arr] of ladderGroups.entries()){
            // Sort ladder lines by numeric line asc
            arr.sort((a,b)=>{
              const la = (a.line!=null && !isNaN(a.line))? Number(a.line): Number.POSITIVE_INFINITY;
              const lb = (b.line!=null && !isNaN(b.line))? Number(b.line): Number.POSITIVE_INFINITY;
              return la - lb;
            });
            const count = arr.length;
            // Compute best edge/ev for summary
            const bestEdge = arr.reduce((m,p)=> (p.edge!=null && (!isNaN(p.edge)) && (m==null || Math.abs(p.edge)>Math.abs(m))? p.edge: m), null);
            const anyEv = arr.find(p=> p.ev_pct!=null && !isNaN(p.ev_pct));
            const evStr = anyEv? `EV ${fmtNum(anyEv.ev_pct)}%`: '';
            const details = document.createElement('details');
            details.className = 'ladder';
            const edgeStr = (bestEdge!=null)? `<span class="edge">Δ ${fmtNum(bestEdge)}</span>`: '';
            details.innerHTML = `
              <summary>
                <div>Ladder: ${market} <span class="badge">${count} lines</span></div>
                <div>${edgeStr} ${evStr? `<span class=\"ev\">${evStr}</span>`: ''}</div>
              </summary>
              <div class="ladder-rows"></div>
            `;
            const rowsRoot = details.querySelector('.ladder-rows');
            arr.forEach(p=>{
              const evNum = (p.ev_pct!=null && !isNaN(p.ev_pct)) ? `${fmtNum(p.ev_pct)}%` : null;
              const edge = (p.edge!=null)? `<span class=\"edge\">Δ ${fmtNum(p.edge)}</span>`: '';
              const o = p.over_price!=null? Number(p.over_price): null;
              const u = p.under_price!=null? Number(p.under_price): null;
              const line = (p.line!=null? p.line : null);
              const row = document.createElement('div');
              row.className='ladder-row ' + (p.side==='Over'?'over-row': (p.side==='Under'?'under-row':''));
              const sideIcon = p.side==='Over'? '↑' : (p.side==='Under'? '↓' : '');
              row.innerHTML = `
                <div>${sideIcon? `<span title=\"${p.side}\">${sideIcon}</span> `:''}${p.side||''}${line!=null? ' '+line: ''}</div>
                <div>${edge} ${evNum? `<span class=\"ev\">EV ${evNum}</span>`: ''}
                  <span class=\"price\"><span class=\"label ${p.side==='Over'?'over-rec':''}\">O</span><span class=\"val ${p.side==='Over'?'sel over-rec':''}\">${o!=null? o: ''}</span></span>
                  <span class=\"price\"><span class=\"label ${p.side==='Under'?'under-rec':''}\">U</span><span class=\"val ${p.side==='Under'?'sel under-rec':''}\">${u!=null? u: ''}</span></span>
                </div>
              `;
              rowsRoot.appendChild(row);
            });
            plays.appendChild(details);
          }
        }
        root.appendChild(div);
      });
    }

  document.getElementById('filters').addEventListener('submit', (e)=>{ e.preventDefault(); loadData(); });
  document.getElementById('hideLadders').addEventListener('change', ()=>{ updateUrlFromControls(); renderCards(LAST_DATA); });
  document.getElementById('marketFilter').addEventListener('change', ()=>{ updateUrlFromControls(); renderCards(LAST_DATA); });
  document.getElementById('onlyEV').addEventListener('change', ()=>{ updateUrlFromControls(); renderCards(LAST_DATA); });
  document.getElementById('minEV').addEventListener('input', ()=>{ updateUrlFromControls(); renderCards(LAST_DATA); });
  document.getElementById('topEV').addEventListener('change', ()=>{ updateUrlFromControls(); renderCards(LAST_DATA); });
  document.getElementById('sortBy').addEventListener('change', ()=>{ updateUrlFromControls(); renderCards(LAST_DATA); });
  document.getElementById('reset').addEventListener('click', ()=>{ document.getElementById('season').value=''; document.getElementById('week').value=''; document.getElementById('game').value=''; document.getElementById('marketFilter').value=''; document.getElementById('onlyEV').checked=false; document.getElementById('minEV').value=''; document.getElementById('topEV').checked=false; document.getElementById('sortBy').value='ev_desc'; document.getElementById('hideLadders').checked=false; updateUrlFromControls(); loadData(); });
  // On first load, hydrate controls from URL before fetching
  window.addEventListener('load', ()=>{ syncControlsFromUrl(); loadData(); });
    
  </script>
</body>
</html>
