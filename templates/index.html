<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NFL Betting – Cards</title>
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://a.espncdn.com">
  <link rel="dns-prefetch" href="https://a.espncdn.com">
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="color-scheme" content="dark light" />
  <style>
    /* High-contrast tokens (Dark by default) */
    :root{
      --bg:#080d1a;            /* darker background for stronger contrast */
      --card:#0d1426;
      --card2:#121b31;
      --text:#f5f7ff;          /* brighter primary text */
      --muted:#c3cee4;         /* higher-contrast muted text */
      --chip:#141b2e;
      --chip-br:#2a3a63;
      --link:#b8d1ff;
      --pill-bg:#101a2e;
      --pill-br:#2a3a63;
      --badge-bg:#162247;
      --badge-br:#2a3a63;
      --input-bg:#121b31;
      --input-br:#243356;
      --button-bg:#1b2339;
      --button-br:#2a3a63;
      --button-text:#e6edf7;
    }
    /* Light theme overrides */
    body.light{
      --bg:#ffffff;
      --card:#f8fafc;
      --card2:#eef2f7;
      --text:#0a0f1c;
      --muted:#475569;
      --chip:#eef2ff;
      --chip-br:#cbd5e1;
      --link:#1e40af;
      --pill-bg:#f1f5f9;
      --pill-br:#cbd5e1;
      --badge-bg:#e2e8f0;
      --badge-br:#cbd5e1;
      --input-bg:#ffffff;
      --input-br:#94a3b8;
      --button-bg:#f1f5f9;
      --button-br:#94a3b8;
      --button-text:#0a0f1c;
    }
  /* Base resets and globals */
  *, *::before, *::after{ box-sizing: border-box }
  img{ display:block; max-width:100%; height:auto }
  a{ color:var(--link) }
  body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:var(--text)}
    .container{max-width:1400px;margin:24px auto;padding:0 18px}
    h1{font-size:24px;margin:0 0 8px}
    .meta{color:var(--muted);font-size:14px;margin-bottom:14px}
    .nav{margin-bottom:12px}
    .nav a{color:var(--link);text-decoration:none;margin-right:10px}
    .nav button.theme-toggle{background:var(--button-bg);color:var(--button-text);border:1px solid var(--button-br);border-radius:6px;padding:6px 10px;cursor:pointer}
    .theme-toggle{background:var(--button-bg);color:var(--button-text);border:1px solid var(--button-br);border-radius:6px;padding:6px 10px;cursor:pointer}
    .filters{display:flex;gap:8px;align-items:center;margin:12px 0 16px}
    .filters input{background:var(--input-bg);border:1px solid var(--input-br);color:var(--text);padding:6px 8px;border-radius:6px;width:120px}
    .filters button{background:var(--button-bg);color:var(--button-text);border:1px solid var(--button-br);border-radius:6px;padding:6px 10px;cursor:pointer}
  /* One game card per row (full width) */
  .grid{display:grid;grid-template-columns:1fr;gap:18px}
  .card{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid #1f2a44;border-radius:16px;padding:16px 16px 14px 16px;box-shadow:0 10px 22px rgba(0,0,0,.28);min-width:0}
    .row{display:flex;justify-content:space-between;align-items:center}
  .teams{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center}
    .name{font-weight:700}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-br);font-size:13px;color:var(--text)}
    .pred{display:flex;justify-content:space-between;align-items:baseline;font-variant-numeric:tabular-nums;margin:6px 0}
    .score{font-size:20px;font-weight:800}
    .muted{color:var(--muted);font-size:13px}
  .pill{display:inline-block;padding:3px 8px;border-radius:6px;border:1px solid var(--pill-br);background:var(--pill-bg);font-size:13px;color:var(--text)}
  .pill-ok{border-color:#2e8b57;color:#9ae6b4}
  .pill-bad{border-color:#8b2e2e;color:#fca5a5}
  .kpi{display:flex;gap:10px;align-items:center;justify-content:flex-start;margin-top:6px}
  .recs{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .badge{display:inline-block;padding:5px 10px;border-radius:999px;border:1px solid var(--badge-br);background:var(--badge-bg);font-size:13px;color:var(--text)}
  .b-low{box-shadow:inset 0 0 0 1px #375a7f}
  .b-med{box-shadow:inset 0 0 0 1px #7f7f37}
  .b-high{box-shadow:inset 0 0 0 1px #2e8b57}
  /* Summary cards row (season to date) */
  .cards-summary{display:flex;flex-wrap:wrap;gap:12px;margin:12px 0;align-items:stretch}
  .card-summary{flex:1;min-width:240px;padding:10px;background:linear-gradient(180deg,#132a52,#0d1426)}
  .card-tier{flex:1;min-width:200px;padding:10px}
  .title-sm{font-size:14px;letter-spacing:.5px;text-transform:uppercase;color:var(--muted)}
  .title-lg{font-size:20px;font-weight:600}
  .title-md{font-size:18px;font-weight:600}
  .muted-small{font-size:12px;color:var(--muted)}
  .muted-tiny{font-size:11px;color:var(--muted)}
  .odds{margin-top:8px;border-top:1px dashed var(--pill-br);padding-top:8px;display:none}
  .odds .row{display:flex;justify-content:space-between;font-size:13px;margin:4px 0;color:var(--text)}
  .odds .muted{color:var(--muted)}
  /* Top prop edges (always visible when present) */
  .props{margin-top:8px;border-top:1px dashed var(--pill-br);padding-top:8px}
  .props .row{display:flex;justify-content:space-between;font-size:13px;margin:4px 0;color:var(--text)}
  .props .muted{color:var(--muted)}
  /* Ratings panel mirrors odds styles */
  .ratings{margin-top:8px;border-top:1px dashed var(--pill-br);padding-top:8px;display:none}
  .ratings .row{display:flex;justify-content:space-between;font-size:13px;margin:4px 0;color:var(--text)}
  .ratings .muted{color:var(--muted)}
  .venue{color:var(--muted);font-size:12px;margin-top:6px}
  .status{font-weight:700;font-size:12px;color:var(--text)}
  .team-block{display:grid;grid-template-columns:auto 1fr auto;gap:6px;align-items:center}
  .team-name{font-weight:700}
  .tiny{font-size:11px;color:var(--muted)}
  /* --- Box-score card layout --- */
  .section-title{font-size:12px;letter-spacing:.7px;text-transform:uppercase;color:var(--muted);margin-top:12px;margin-bottom:8px}
  .boxscore{margin-top:10px}
  .boxscore-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:6px}
  .boxteam-card{background:rgba(0,0,0,.10);border:1px solid var(--pill-br);border-radius:12px;padding:12px;min-width:0}
  body.light .boxteam-card{background:rgba(0,0,0,.02)}
  .boxteam-head{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px}
  .boxteam-left{display:flex;align-items:center;gap:8px;min-width:0}
  .boxteam-left .team-logo{width:20px;height:20px}
  .boxteam-left .pill{max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .boxteam-head .pill{white-space:nowrap}
  .boxteam-chip{display:inline-flex;align-items:center;gap:6px;padding:2px 6px;border-radius:999px;border:1px solid var(--pill-br);background:var(--pill-bg);font-size:11px;color:var(--text);font-variant-numeric:tabular-nums;white-space:nowrap}
  .boxteam-chip .k{color:var(--muted);text-transform:uppercase;letter-spacing:.5px;font-size:10px}

  /* --- Compact mock boxscore + props tables --- */
  .mock-head{display:flex;justify-content:space-between;align-items:baseline;gap:10px;margin-bottom:6px}
  .mock-team{display:flex;flex-direction:column;min-width:0;line-height:1.05}
  .mock-team .abbr{font-weight:900;letter-spacing:.8px}
  .mock-team .full{color:var(--muted);font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
  .mock-pts{font-variant-numeric:tabular-nums;font-size:12px;white-space:nowrap}
  .mock-pts .k{color:var(--muted);text-transform:uppercase;letter-spacing:.5px;font-size:10px}
  .mock-lines{display:flex;flex-direction:column;gap:6px;margin-top:4px}
  /* Use fixed stat columns so player name never collapses to 0 width */
  .mockline{display:grid;grid-template-columns:44px minmax(0,1fr) 54px 54px 54px;gap:10px;align-items:baseline;padding-top:6px;border-top:1px solid rgba(255,255,255,.06)}
  body.light .mockline{border-top:1px solid rgba(0,0,0,.08)}
  .mockline:first-child{border-top:none;padding-top:0}
  .mockcat{color:var(--muted);font-size:11px;letter-spacing:.4px;text-transform:uppercase}
  .mockplayer{font-weight:800;font-size:13px;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .mockstat{display:flex;flex-direction:column;align-items:flex-end;line-height:1.05;min-width:0}
  .mockstat .k{color:var(--muted);font-size:10px;letter-spacing:.4px;text-transform:uppercase}
  .mockstat .v{font-size:12px;font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .mockstat .v.big{font-weight:800}

  .props-table{margin-top:0}
  .props-table .row{display:grid;grid-template-columns:1fr 84px;gap:12px;align-items:baseline}
  .props-table .row.head{margin-top:0}
  .props-table .row.head span{color:var(--muted);font-size:11px;letter-spacing:.5px;text-transform:uppercase}
  .props-table .row .val{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;text-align:right;white-space:nowrap}
  .props-table .proptext{min-width:0}
  /* Allow 2-line wrapping for dense prop text instead of hard ellipsis */
  .props-table .proptext .l1{color:var(--text);font-size:13px;line-height:1.25;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  .props-table .proptext .l2{color:var(--muted);font-size:12px;line-height:1.2;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .props-table .pill{margin-right:6px}
  .boxline{display:flex;justify-content:space-between;align-items:baseline;gap:10px;padding:4px 0;border-top:1px solid rgba(255,255,255,.06)}
  body.light .boxline{border-top:1px solid rgba(0,0,0,.08)}
  .boxline:first-of-type{border-top:none}
  .boxlabel{color:var(--muted);font-size:11px;letter-spacing:.4px;text-transform:uppercase;min-width:44px}
  .boxname{font-weight:800;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
  .boxstats{font-size:12px;color:var(--text);font-variant-numeric:tabular-nums;text-align:right;white-space:nowrap}
  .boxmuted{color:var(--muted);font-size:12px}
  .box-table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--pill-br);border-radius:10px;overflow:hidden;font-variant-numeric:tabular-nums}
  .box-table thead th{background:rgba(0,0,0,.18);color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.6px;padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.06)}
  body.light .box-table thead th{background:rgba(0,0,0,.04);border-bottom:1px solid rgba(0,0,0,.08)}
  .box-table td{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.06)}
  body.light .box-table td{border-bottom:1px solid rgba(0,0,0,.08)}
  .box-table tbody tr:last-child td{border-bottom:none}
  .box-table .why-cell{max-width:340px;white-space:normal;line-height:1.2}
  .box-team{display:flex;align-items:center;gap:8px;min-width:0}
  .box-team .team-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .team-stack{display:flex;flex-direction:column;min-width:0;line-height:1.05}
  .team-abbr{font-weight:900;letter-spacing:.8px}
  .team-full{color:var(--muted);font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
  .box-table .num{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;letter-spacing:.2px}
  .box-table td{padding:5px 8px}
  .box-table thead th{padding:5px 8px}
  .box-final{font-weight:800}
  .simbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .simitem{flex:1;min-width:160px;background:var(--pill-bg);border:1px solid var(--pill-br);border-radius:10px;padding:8px}
  .simitem .k{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.6px}
  .simitem .v{font-size:14px;font-weight:700;margin-top:2px}
  .rec-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:10px}
  .rec-card{background:var(--pill-bg);border:1px solid var(--pill-br);border-radius:12px;padding:12px;min-width:0}
  .rec-title{font-size:13px;font-weight:800;margin-bottom:8px}
  .rec-line{display:flex;justify-content:space-between;gap:10px;font-size:13px;margin:4px 0}
  .rec-line .muted{font-size:13px}
  .two-col{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:10px}
  .panel{background:var(--pill-bg);border:1px solid var(--pill-br);border-radius:12px;padding:12px;min-width:0}
  .mt0{margin-top:0!important}
  .props-compact{border-top:none!important;padding-top:0!important;margin-top:0!important}
  .full-panel{margin-top:10px}

  .table-scroll{overflow:auto}
  .mockbox-table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--pill-br);border-radius:12px;overflow:hidden;font-variant-numeric:tabular-nums;background:rgba(0,0,0,.08);font-size:12px}
  body.light .mockbox-table{background:rgba(0,0,0,.02)}
  .mockbox-table thead th{background:rgba(0,0,0,.18);color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.6px;padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.06)}
  body.light .mockbox-table thead th{background:rgba(0,0,0,.04);border-bottom:1px solid rgba(0,0,0,.08)}
  .mockbox-table td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:top}
  body.light .mockbox-table td{border-bottom:1px solid rgba(0,0,0,.08)}
  .mockbox-table tbody tr:last-child td{border-bottom:none}
  .mockbox-minihead td{background:rgba(0,0,0,.14);color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.5px;padding:6px 10px}
  body.light .mockbox-minihead td{background:rgba(0,0,0,.03)}
  .mockbox-teamhead{display:flex;align-items:baseline;justify-content:space-between;gap:12px;min-width:0}
  .mockbox-teamname{display:flex;flex-direction:column;min-width:0;line-height:1.05}
  .mockbox-teamname .abbr{font-weight:900;letter-spacing:.8px}
  .mockbox-teamname .full{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:360px}
  .mockbox-pts{white-space:nowrap;font-variant-numeric:tabular-nums}
  .mockbox-pts .k{font-size:10px;letter-spacing:.5px;color:var(--muted)}
  .mockbox-subhead{font-size:11px;color:var(--muted);letter-spacing:.4px;text-transform:uppercase}
  .mockbox-cat{display:flex;flex-direction:column;gap:2px}
  .mockbox-cat .k{font-weight:800;letter-spacing:.5px}
  .mockbox-cat .s{font-size:10px;color:var(--muted);letter-spacing:.4px;text-transform:uppercase}
  .mockbox-player{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:280px;font-size:12px}
  .mockbox-num{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;text-align:right;white-space:nowrap;font-size:12px}
  .mockbox-num.miss{color:var(--muted)}
  .mockbox-num .sub{display:block;font-size:10px;letter-spacing:.3px;color:var(--muted);white-space:normal;line-height:1.1;margin-top:2px}
  .drive-mt{margin-top:8px}
  .drive-scroll{max-height:220px;overflow:auto;margin-top:6px}
  @media(max-width:760px){
    .rec-grid{grid-template-columns:1fr}
    .two-col{grid-template-columns:1fr}
    .boxscore-grid{grid-template-columns:1fr}
    .boxname{max-width:100%}
    .mockline{grid-template-columns:40px minmax(0,1fr) 50px 50px 50px;gap:8px}
  }
  /* Admin panel styles */
  #adminPanel{display:none;border:1px solid var(--button-br);background:var(--card2);border-radius:10px;padding:10px;margin:10px 0}
  .admin-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .label-sm{font-size:12px;color:var(--muted)}
  #adminKeyInput{width:200px;padding:4px 6px;border-radius:6px;background:var(--input-bg);border:1px solid var(--input-br);color:var(--text)}
  .align-mid{vertical-align:middle;margin-right:6px}
  #adminLogs{max-height:260px;overflow:auto;margin:0;background:var(--chip);border:1px solid var(--chip-br);border-radius:8px;padding:8px;color:var(--text)}
  /* Utilities */
  .mt-8{margin-top:8px}
  .mt-16{margin-top:16px}
  .ml-8{margin-left:8px}
  .center{text-align:center}
  .tal{text-align:left}
  .tar{text-align:right}
  .my-2{margin:2px 0}
  .op-75{opacity:.75}
  .fs-13{font-size:13px}
  .team-logo{width:28px;height:28px;object-fit:contain;border-radius:4px}
  /* --- Mobile Enhancements --- */
  @media (max-width:760px){
    .container{padding:0 10px;margin:12px auto}
    h1{font-size:18px;margin-bottom:4px}
    .nav{font-size:12px;overflow-x:auto;white-space:nowrap;padding-bottom:4px}
    .nav a, .nav button{display:inline-block;margin-right:6px;padding:4px 8px;font-size:12px}
    .filters{flex-wrap:wrap;gap:6px}
    .filters label{font-size:12px}
    .filters input, .filters select{width:92px;padding:4px 6px;font-size:12px}
    .filters button{padding:4px 8px;font-size:12px}
    .grid{grid-template-columns:1fr;gap:12px}
    .card{padding:10px 10px 8px;border-radius:12px}
  .team-block img{width:24px;height:24px}
    .score{font-size:16px}
    .chip{font-size:11px;padding:3px 6px}
    .badge{font-size:11px;padding:3px 6px}
    .pill{font-size:11px}
    .pred{flex-direction:column;align-items:flex-start;gap:2px;font-size:11px}
    .kpi{flex-wrap:wrap}
    .odds .row{font-size:11px}
    .ratings .row{font-size:11px}
    .venue{font-size:11px}
    .status{font-size:11px}
  }
  </style>
</head>
<body>
  <div class="container">
  <div class="nav"><a href="/">Cards</a> | <a href="/recommendations">Recommendations</a> | <a href="/props">Props</a> | <a href="/props/recommendations">Props Recs</a> | <a href="/reconciliation">Reconciliation</a> | <a href="/roster-validation{% if season or week %}?{% if season %}season={{ season }}{% endif %}{% if season and week %}&{% endif %}{% if week %}week={{ week }}{% endif %}{% endif %}" target="_blank">Roster Validation</a> | <a href="/api/predictions" target="_blank">API</a> | <a href="/api/odds-coverage" target="_blank">Odds Coverage</a> | <a href="/health" target="_blank">Health</a> | <button type="button" class="theme-toggle" id="themeToggle" title="Toggle light/dark">Toggle Theme</button> | <button type="button" class="theme-toggle" id="toggleAllOdds" title="Show/Hide all odds panels">Hide All Odds</button> | <button type="button" class="theme-toggle" id="toggleAllRatings" title="Show/Hide all ratings panels">Hide All Ratings</button> | <button type="button" class="theme-toggle" id="adminRunDU" title="Run daily update (admin)">Run Update</button> | <button type="button" class="theme-toggle" id="adminToggle" title="Show admin panel">Admin Panel</button></div>
  <div id="adminPanel">
    <div class="admin-row">
      <label class="label-sm">Key: <input id="adminKeyInput" type="password" placeholder="ADMIN_KEY" /></label>
      <label class="label-sm"><input id="adminPushToggle" type="checkbox" checked class="align-mid"/> Push to Git</label>
      <button id="adminStart" class="theme-toggle">Start Update</button>
      <span id="adminState" class="label-sm">Idle</span>
    </div>
    <pre id="adminLogs"></pre>
  </div>
    <h1>NFL Betting – Cards (Boxscore UI)</h1>
    <div class="meta">{{ total_rows }} rows {{ '(filtered)' if season or week else '' }}</div>
    {% if accuracy_s2d %}
      <div class="cards-summary">
        {% set overall = accuracy_s2d.get('Overall') %}
        {% if overall %}
          <div class="card card-summary">
            <div class="title-sm">Season to date</div>
            <div class="mt-4 title-lg">
              {% if overall.accuracy_pct is not none %}{{ '%.1f' % overall.accuracy_pct }}% Accuracy{% else %}—{% endif %}
            </div>
            <div class="muted-small mt-4">
              {{ overall.wins }}W-{{ overall.losses }}L{% if overall.pushes %}-{{ overall.pushes }}P{% endif %} / {{ overall.resolved }} settled
            </div>
            <div class="mt-4 muted-small">ROI: {% if overall.roi_pct is not none %}{{ '%.1f' % overall.roi_pct }}%{% else %}—{% endif %}</div>
            <div class="mt-4 muted-tiny">Stake: ${{ '%.0f' % overall.stake_total }} | P/L: ${{ '%.0f' % overall.profit_total }}</div>
            <div class="mt-4 muted-tiny">Total picks: {{ overall.total }}</div>
          </div>
        {% endif %}
        {% for tier in ['High','Medium','Low'] %}
          {% set m = accuracy_s2d.get(tier) %}
          <div class="card card-tier">
            <div class="title-sm">{{ tier }}</div>
            <div class="mt-4 title-md">
              {% if m.accuracy_pct is not none %}{{ '%.1f' % m.accuracy_pct }}% Acc{% else %}—{% endif %}
            </div>
            <div class="muted-small mt-4">
              {{ m.wins }}W-{{ m.losses }}L{% if m.pushes %}-{{ m.pushes }}P{% endif %} / {{ m.resolved }}
            </div>
            <div class="mt-4 muted-small">ROI: {% if m.roi_pct is not none %}{{ '%.1f' % m.roi_pct }}%{% else %}—{% endif %}</div>
            <div class="mt-4 muted-tiny">Stake: ${{ '%.0f' % m.stake_total }} | P/L: ${{ '%.0f' % m.profit_total }}</div>
            <div class="mt-4 muted-tiny">Picks: {{ m.total }}</div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
    {% if show_week_summary and accuracy_week %}
      <div class="cards-summary">
        {% set overall_wk = accuracy_week.get('Overall') %}
        {% if overall_wk %}
          <div class="card card-summary">
            <div class="title-sm">This week</div>
            <div class="mt-4 title-lg">
              {% if overall_wk.accuracy_pct is not none %}{{ '%.1f' % overall_wk.accuracy_pct }}% Accuracy{% else %}—{% endif %}
            </div>
            <div class="muted-small mt-4">
              {{ overall_wk.wins }}W-{{ overall_wk.losses }}L{% if overall_wk.pushes %}-{{ overall_wk.pushes }}P{% endif %} / {{ overall_wk.resolved }} settled
            </div>
            <div class="mt-4 muted-small">ROI: {% if overall_wk.roi_pct is not none %}{{ '%.1f' % overall_wk.roi_pct }}%{% else %}—{% endif %}</div>
            <div class="mt-4 muted-tiny">Stake: ${{ '%.0f' % overall_wk.stake_total }} | P/L: ${{ '%.0f' % overall_wk.profit_total }}</div>
            <div class="mt-4 muted-tiny">Total picks: {{ overall_wk.total }}</div>
          </div>
        {% endif %}
        {% for tier in ['High','Medium','Low'] %}
          {% set m = accuracy_week.get(tier) %}
          <div class="card card-tier">
            <div class="title-sm">{{ tier }}</div>
            <div class="mt-4 title-md">
              {% if m.accuracy_pct is not none %}{{ '%.1f' % m.accuracy_pct }}% Acc{% else %}—{% endif %}
            </div>
            <div class="muted-small mt-4">
              {{ m.wins }}W-{{ m.losses }}L{% if m.pushes %}-{{ m.pushes }}P{% endif %} / {{ m.resolved }}
            </div>
            <div class="mt-4 muted-small">ROI: {% if m.roi_pct is not none %}{{ '%.1f' % m.roi_pct }}%{% else %}—{% endif %}</div>
            <div class="mt-4 muted-tiny">Stake: ${{ '%.0f' % m.stake_total }} | P/L: ${{ '%.0f' % m.profit_total }}</div>
            <div class="mt-4 muted-tiny">Picks: {{ m.total }}</div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
    <form class="filters" method="get" action="/">
      <label>Season: <input type="number" name="season" value="{{ season or '' }}" /></label>
      <label>Week: <input type="number" name="week" value="{{ week or '' }}" /></label>
      <label>Sort:
        <select name="sort">
          <option value="date" {{ 'selected' if (sort or 'date')=='date' else '' }}>Date/Time</option>
          <option value="winner" {{ 'selected' if sort=='winner' else '' }}>Winner EV</option>
          <option value="ats" {{ 'selected' if sort=='ats' else '' }}>ATS Edge</option>
          <option value="total" {{ 'selected' if sort=='total' else '' }}>Total Edge</option>
        </select>
      </label>
      <button type="submit">Apply</button>
    <a href="/">Reset</a>
  <a href="/api/refresh-data" class="ml-8" title="Rebuild predictions (server-side)">Refresh Data</a>
  <a href="/api/refresh-odds" class="ml-8" title="Fetch real odds and rebuild">Refresh Odds</a>
    </form>

    {% if have_data %}
      <div class="grid">
        {% for g in cards %}
          <div class="card"{% if g.game_id %} data-game-id="{{ g.game_id }}"{% endif %}>
            <div class="venue">{{ g.venue_text }}</div>
            <div class="status">{{ g.status_text }}</div>

            {% set exs = g.explain.simulation if g.explain %}
            {% set exk = g.explain.market if g.explain %}
            {% set qsrc = (g.sim_quarters if g.sim_quarters else g.quarters) %}

            <div class="boxscore">
              <div class="section-title">Box Score{% if g.sim_quarters %} (Sim){% elif g.quarters %} (Model){% endif %}</div>
              <table class="box-table">
                <thead>
                  <tr>
                    <th class="tal">Team</th>
                    <th class="tar">1</th>
                    <th class="tar">2</th>
                    <th class="tar">3</th>
                    <th class="tar">4</th>
                    <th class="tar">T</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      <div class="box-team">
                        {% if g.away_logo %}<img src="{{ g.away_logo }}" alt="{{ g.away_team }}" class="team-logo" />{% endif %}
                        <div class="team-stack">
                          <div class="team-abbr dynamic-color" title="{{ g.away_team }}" data-color="{{ g.away_color|default('#e6edf7', true) }}" data-color2="{{ g.away_color2|default('', true) }}">{{ g.away_abbr or g.away_team }}</div>
                        </div>
                      </div>
                    </td>
                    {% for i in range(4) %}
                      {% set qq = (qsrc[i] if (qsrc and (qsrc|length) > i) else none) %}
                      <td class="tar num">{% if qq and qq.away is number %}{{ '%.0f' % qq.away }}{% else %}-{% endif %}</td>
                    {% endfor %}
                    <td class="tar box-final num">
                      {% if g.away_score is not none %}
                        {{ '%.0f' % g.away_score }}
                      {% elif exs and exs.away_points is number %}
                        {{ '%.1f' % exs.away_points }}
                      {% elif g.pred_away_points is not none %}
                        {{ '%.1f' % g.pred_away_points }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <div class="box-team">
                        {% if g.home_logo %}<img src="{{ g.home_logo }}" alt="{{ g.home_team }}" class="team-logo" />{% endif %}
                        <div class="team-stack">
                          <div class="team-abbr dynamic-color" title="{{ g.home_team }}" data-color="{{ g.home_color|default('#e6edf7', true) }}" data-color2="{{ g.home_color2|default('', true) }}">{{ g.home_abbr or g.home_team }}</div>
                        </div>
                      </div>
                    </td>
                    {% for i in range(4) %}
                      {% set qq = (qsrc[i] if (qsrc and (qsrc|length) > i) else none) %}
                      <td class="tar num">{% if qq and qq.home is number %}{{ '%.0f' % qq.home }}{% else %}-{% endif %}</td>
                    {% endfor %}
                    <td class="tar box-final num">
                      {% if g.home_score is not none %}
                        {{ '%.0f' % g.home_score }}
                      {% elif exs and exs.home_points is number %}
                        {{ '%.1f' % exs.home_points }}
                      {% elif g.pred_home_points is not none %}
                        {{ '%.1f' % g.pred_home_points }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                  </tr>
                </tbody>
              </table>
              <div class="muted-tiny mt-4">
                {% if g.away_score is none and g.home_score is none %}
                  Final is projected{% if g.sim_quarters or (exs and (exs.total is number)) %} (sim){% else %} (model){% endif %}.
                {% else %}
                  Final is actual.
                {% endif %}
              </div>
            </div>

            <div class="simbar">
              <div class="simitem">
                <div class="k">Simulation</div>
                <div class="v">
                  {% if exs and exs.total is number %}
                    Total {{ '%.1f' % exs.total }} • Margin {{ '%+.1f' % exs.margin if exs.margin is number else '—' }}
                  {% elif g.pred_total is number %}
                    Total {{ '%.1f' % g.pred_total }}
                  {% else %}
                    —
                  {% endif %}
                </div>
                <div class="muted-tiny">
                  {% if exs and exs.prob_home_win_mc is number %}ML {{ '%.0f' % (exs.prob_home_win_mc*100) }}%{% else %}ML —{% endif %}
                  &nbsp;•&nbsp;
                  {% if exs and exs.prob_home_cover_mc is number %}ATS {{ '%.0f' % (exs.prob_home_cover_mc*100) }}%{% else %}ATS —{% endif %}
                  &nbsp;•&nbsp;
                  {% if exs and exs.prob_over_total_mc is number %}Over {{ '%.0f' % (exs.prob_over_total_mc*100) }}%{% else %}Over —{% endif %}
                </div>
              </div>
              <div class="simitem">
                <div class="k">Market</div>
                <div class="v">
                  {% if g.market_spread_home is number %}{{ g.home_team }} {{ '%+.1f' % g.market_spread_home }}{% else %}Spread —{% endif %}
                  &nbsp;•&nbsp;
                  {% if g.market_total is number %}Total {{ '%.1f' % g.market_total }}{% else %}Total —{% endif %}
                </div>
                <div class="muted-tiny">
                  {% if g.moneyline_away is number or g.moneyline_home is number %}
                    ML {% if g.moneyline_away is number %}Away {{ '%+d' % g.moneyline_away }}{% else %}Away —{% endif %} / {% if g.moneyline_home is number %}Home {{ '%+d' % g.moneyline_home }}{% else %}Home —{% endif %}
                  {% else %}
                    ML —
                  {% endif %}
                </div>
              </div>
              <div class="simitem">
                <div class="k">Actual</div>
                <div class="v">
                  {% if g.actual_total is number %}
                    Total {{ '%.1f' % g.actual_total }} • Diff {{ '%.1f' % g.total_diff if g.total_diff is number else '—' }}
                  {% else %}
                    —
                  {% endif %}
                </div>
                <div class="muted-tiny">
                  {% if g.actual_total is not none %}
                    Winner {{ '✓' if g.winner_correct else '✗' if g.winner_correct is not none else '—' }} • ATS {{ '✓' if g.ats_correct else '✗' if g.ats_correct is not none else '—' }} • Total {{ '✓' if g.totals_correct else '✗' if g.totals_correct is not none else '—' }}
                  {% else %}
                    Not settled
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="section-title">Betting Recommendations</div>
            <div class="rec-grid">
              <div class="rec-card">
                <div class="rec-title">Moneyline</div>
                <div class="rec-line">
                  <span class="muted">Sim</span>
                  <span>
                    {% if g.sim_rec_winner_side %}{{ g.sim_rec_winner_side }}{% else %}—{% endif %}
                    {% if g.sim_rec_winner_ev is not none %}<span class="muted"> (EV {{ '%.1f' % (g.sim_rec_winner_ev*100) }}%)</span>{% endif %}
                    {% if g.sim_rec_winner_conf %}<span class="muted"> • {{ g.sim_rec_winner_conf }}</span>{% endif %}
                  </span>
                </div>
                <div class="rec-line">
                  <span class="muted">Model</span>
                  <span>
                    {% if g.rec_winner_side %}{{ g.rec_winner_side }}{% else %}—{% endif %}
                    {% if g.rec_winner_ev is not none %}<span class="muted"> (EV {{ '%.1f' % (g.rec_winner_ev*100) }}%)</span>{% endif %}
                    {% if g.rec_winner_conf %}<span class="muted"> • {{ g.rec_winner_conf }}</span>{% endif %}
                  </span>
                </div>
              </div>

              <div class="rec-card">
                <div class="rec-title">Spread</div>
                <div class="rec-line">
                  <span class="muted">Sim</span>
                  <span>
                    {% if g.sim_rec_spread_side %}{{ g.sim_rec_spread_side }}{% else %}—{% endif %}
                    {% if g.sim_rec_spread_ev is not none %}<span class="muted"> (EV {{ '%.1f' % (g.sim_rec_spread_ev*100) }}%)</span>{% endif %}
                    {% if g.sim_rec_spread_conf %}<span class="muted"> • {{ g.sim_rec_spread_conf }}</span>{% endif %}
                  </span>
                </div>
                <div class="rec-line">
                  <span class="muted">Model</span>
                  <span>
                    {% if g.rec_spread_side %}{{ g.rec_spread_side }}{% else %}—{% endif %}
                    {% if g.rec_spread_ev is not none %}<span class="muted"> (EV {{ '%.1f' % (g.rec_spread_ev*100) }}%)</span>{% endif %}
                    {% if g.rec_spread_conf %}<span class="muted"> • {{ g.rec_spread_conf }}</span>{% endif %}
                  </span>
                </div>
              </div>

              <div class="rec-card">
                <div class="rec-title">Total</div>
                <div class="rec-line">
                  <span class="muted">Sim</span>
                  <span>
                    {% if g.sim_rec_total_side %}{{ g.sim_rec_total_side }}{% else %}—{% endif %}
                    {% if g.sim_rec_total_ev is not none %}<span class="muted"> (EV {{ '%.1f' % (g.sim_rec_total_ev*100) }}%)</span>{% endif %}
                    {% if g.sim_rec_total_conf %}<span class="muted"> • {{ g.sim_rec_total_conf }}</span>{% endif %}
                  </span>
                </div>
                <div class="rec-line">
                  <span class="muted">Model</span>
                  <span>
                    {% if g.rec_total_side %}{{ g.rec_total_side }}{% else %}—{% endif %}
                    {% if g.rec_total_ev is not none %}<span class="muted"> (EV {{ '%.1f' % (g.rec_total_ev*100) }}%)</span>{% endif %}
                    {% if g.rec_total_conf %}<span class="muted"> • {{ g.rec_total_conf }}</span>{% endif %}
                  </span>
                </div>
              </div>
            </div>

            <div class="panel">
              <div class="section-title mt0">Game Story (Sim)</div>

              {% if g.sim_story %}
                {% for p in g.sim_story %}
                  <div class="muted-small my-2">{{ p }}</div>
                {% endfor %}
              {% elif g.sim_recap %}
                <div class="muted-small my-2">{{ g.sim_recap }}</div>
              {% else %}
                <div class="muted-small my-2">—</div>
              {% endif %}

              {% if g.sim_key_drives %}
                <div class="muted-tiny drive-mt">Key drives (Sim){% if g.sim_key_drives|length > 0 %} • {{ g.sim_key_drives|length }}{% endif %}</div>
                <div class="drive-scroll">
                  <table class="box-table">
                    <thead>
                      <tr>
                        <th class="tar">D</th>
                        <th class="tar">Q</th>
                        <th>Poss</th>
                        <th class="tar">TOP</th>
                        <th>Outcome</th>
                        <th>Why</th>
                        <th class="tar">Score (A–H)</th>
                        <th class="tar">P(Home lead)</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for d in g.sim_key_drives %}
                        <tr>
                          <td class="tar">{{ d.drive_no }}</td>
                          <td class="tar">{{ d.quarter }}</td>
                          <td>{% if d.poss_team %}{{ d.poss_team }}{% else %}—{% endif %}</td>
                          <td class="tar">
                            {% if d.drive_sec_mean is number %}
                              {% set s = d.drive_sec_mean|round(0, 'floor')|int %}
                              {% set mm = (s // 60) %}
                              {% set ss = (s % 60) %}
                              {{ '%d:%02d' % (mm, ss) }}
                              {% if d.drive_sec_p25 is number and d.drive_sec_p75 is number %}
                                {% set s25 = d.drive_sec_p25|round(0, 'floor')|int %}
                                {% set s75 = d.drive_sec_p75|round(0, 'floor')|int %}
                                <div class="muted-tiny">{{ '%d:%02d' % (s25 // 60, s25 % 60) }}–{{ '%d:%02d' % (s75 // 60, s75 % 60) }}</div>
                              {% endif %}
                            {% else %}
                              —
                            {% endif %}
                          </td>
                          <td>
                            {% if d.drive_outcome_mode %}
                              {{ d.drive_outcome_mode }}
                              {% set p = none %}
                              {% if d.drive_outcome_mode == 'TD' %}{% set p = d.p_drive_td %}{% endif %}
                              {% if d.drive_outcome_mode == 'FG' %}{% set p = d.p_drive_fg %}{% endif %}
                              {% if d.drive_outcome_mode == 'Punt' %}{% set p = d.p_drive_punt %}{% endif %}
                              {% if d.drive_outcome_mode == 'INT' %}{% set p = d.p_drive_int %}{% endif %}
                              {% if d.drive_outcome_mode == 'Fumble' %}{% set p = d.p_drive_fumble %}{% endif %}
                              {% if d.drive_outcome_mode == 'Downs' %}{% set p = d.p_drive_downs %}{% endif %}
                              {% if d.drive_outcome_mode == 'Missed FG' %}{% set p = d.p_drive_missed_fg %}{% endif %}
                              {% if d.drive_outcome_mode == 'End Half' %}{% set p = d.p_drive_end_half %}{% endif %}
                              {% if p is number %} ({{ '%.0f' % (p*100) }}%){% endif %}
                            {% else %}
                              —
                            {% endif %}
                          </td>
                          <td class="why-cell">{% if d.why %}<span class="muted-tiny">{{ d.why }}</span>{% else %}—{% endif %}</td>
                          <td class="tar">
                            {% if d.away_score_mean is number and d.home_score_mean is number %}
                              {{ '%.1f' % d.away_score_mean }}–{{ '%.1f' % d.home_score_mean }}
                            {% else %}
                              —
                            {% endif %}
                          </td>
                          <td class="tar">{% if d.p_home_lead is number %}{{ '%.0f' % (d.p_home_lead*100) }}%{% else %}—{% endif %}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endif %}

              {% if g.sim_drives %}
                <div class="muted-tiny drive-mt op-75">All drives (Sim){% if g.sim_drives|length > 0 %} • showing {{ (g.sim_drives|length) }}{% endif %}</div>
                <div class="drive-scroll">
                  <table class="box-table">
                    <thead>
                      <tr>
                        <th class="tar">D</th>
                        <th class="tar">Q</th>
                        <th>Poss</th>
                        <th class="tar">TOP</th>
                        <th>Outcome</th>
                        <th class="tar">Score (A–H)</th>
                        <th class="tar">P(Home lead)</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for d in g.sim_drives %}
                        <tr>
                          <td class="tar">{{ d.drive_no }}</td>
                          <td class="tar">{{ d.quarter }}</td>
                          <td>{% if d.poss_team %}{{ d.poss_team }}{% else %}—{% endif %}</td>
                          <td class="tar">
                            {% if d.drive_sec_mean is number %}
                              {% set s = d.drive_sec_mean|round(0, 'floor')|int %}
                              {% set mm = (s // 60) %}
                              {% set ss = (s % 60) %}
                              {{ '%d:%02d' % (mm, ss) }}
                            {% else %}
                              —
                            {% endif %}
                          </td>
                          <td>
                            {% if d.drive_outcome_mode %}
                              {{ d.drive_outcome_mode }}
                              {% set p = none %}
                              {% if d.drive_outcome_mode == 'TD' %}{% set p = d.p_drive_td %}{% endif %}
                              {% if d.drive_outcome_mode == 'FG' %}{% set p = d.p_drive_fg %}{% endif %}
                              {% if d.drive_outcome_mode == 'Punt' %}{% set p = d.p_drive_punt %}{% endif %}
                              {% if d.drive_outcome_mode == 'INT' %}{% set p = d.p_drive_int %}{% endif %}
                              {% if d.drive_outcome_mode == 'Fumble' %}{% set p = d.p_drive_fumble %}{% endif %}
                              {% if d.drive_outcome_mode == 'Downs' %}{% set p = d.p_drive_downs %}{% endif %}
                              {% if d.drive_outcome_mode == 'Missed FG' %}{% set p = d.p_drive_missed_fg %}{% endif %}
                              {% if d.drive_outcome_mode == 'End Half' %}{% set p = d.p_drive_end_half %}{% endif %}
                              {% if p is number %} ({{ '%.0f' % (p*100) }}%){% endif %}
                            {% else %}
                              —
                            {% endif %}
                          </td>
                          <td class="tar">
                            {% if d.away_score_mean is number and d.home_score_mean is number %}
                              {{ '%.1f' % d.away_score_mean }}–{{ '%.1f' % d.home_score_mean }}
                            {% else %}
                              —
                            {% endif %}
                          </td>
                          <td class="tar">{% if d.p_home_lead is number %}{{ '%.0f' % (d.p_home_lead*100) }}%{% else %}—{% endif %}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endif %}
            </div>

            <div class="panel full-panel">
              <div class="section-title mt0">Simulated Boxscore (Mock)</div>
              {% if g.sim_boxscore and (g.sim_boxscore.away or g.sim_boxscore.home) %}
                {% set away = g.sim_boxscore.away %}
                {% set home = g.sim_boxscore.home %}
                {% set sim = g.explain.simulation if g.explain and g.explain.simulation else none %}
                {% set away_pts = sim.away_points if sim else none %}
                {% set home_pts = sim.home_points if sim else none %}

                <div class="table-scroll">
                  <table class="mockbox-table">
                    <thead>
                      <tr>
                        <th class="tal">Box</th>
                        <th colspan="4" class="tal">
                          <div class="mockbox-teamhead">
                            <div class="boxteam-left">
                              {% if g.away_logo %}<img class="team-logo" src="{{ g.away_logo }}" alt="{{ g.away_team }}" loading="lazy" />{% endif %}
                              <div class="mockbox-teamname">
                                <div class="abbr dynamic-color" title="{{ g.away_team }}" data-color="{{ g.away_color|default('#e6edf7', true) }}" data-color2="{{ g.away_color2|default('', true) }}">{{ g.away_abbr or g.away_team }}</div>
                              </div>
                            </div>
                            <div class="mockbox-pts">{% if away_pts is number %}<span class="k">Sim pts</span> {{ '%.1f' % away_pts }}{% endif %}</div>
                          </div>
                        </th>
                        <th colspan="4" class="tal">
                          <div class="mockbox-teamhead">
                            <div class="boxteam-left">
                              {% if g.home_logo %}<img class="team-logo" src="{{ g.home_logo }}" alt="{{ g.home_team }}" loading="lazy" />{% endif %}
                              <div class="mockbox-teamname">
                                <div class="abbr dynamic-color" title="{{ g.home_team }}" data-color="{{ g.home_color|default('#e6edf7', true) }}" data-color2="{{ g.home_color2|default('', true) }}">{{ g.home_abbr or g.home_team }}</div>
                              </div>
                            </div>
                            <div class="mockbox-pts">{% if home_pts is number %}<span class="k">Sim pts</span> {{ '%.1f' % home_pts }}{% endif %}</div>
                          </div>
                        </th>
                      </tr>
                      <tr>
                        <th class="tal"><span class="mockbox-subhead">Unit</span></th>
                        <th class="tal"><span class="mockbox-subhead">Player</span></th>
                        <th class="tar"><span class="mockbox-subhead">S1</span></th>
                        <th class="tar"><span class="mockbox-subhead">S2</span></th>
                        <th class="tar"><span class="mockbox-subhead">S3</span></th>
                        <th class="tal"><span class="mockbox-subhead">Player</span></th>
                        <th class="tar"><span class="mockbox-subhead">S1</span></th>
                        <th class="tar"><span class="mockbox-subhead">S2</span></th>
                        <th class="tar"><span class="mockbox-subhead">S3</span></th>
                      </tr>
                    </thead>
                    <tbody>
                      {# PASS rows #}
                      {% set ap = (away.passers if away and away.passers else []) %}
                      {% set hp = (home.passers if home and home.passers else []) %}
                      {% set n_pass = (ap|length) if (ap|length) > (hp|length) else (hp|length) %}
                      {% if n_pass < 1 %}{% set n_pass = 1 %}{% endif %}
                      <tr class="mockbox-minihead">
                        <td></td><td></td>
                        <td class="tar">YDS</td><td class="tar">TD</td><td class="tar">INT</td>
                        <td></td>
                        <td class="tar">YDS</td><td class="tar">TD</td><td class="tar">INT</td>
                      </tr>
                      {% for i in range(n_pass) %}
                        {% set pa = ap[i] if i < (ap|length) else none %}
                        {% set ph = hp[i] if i < (hp|length) else none %}
                        <tr>
                          <td class="tal">
                            {% if i == 0 %}
                              <div class="mockbox-cat"><div class="k">PASS</div><div class="s">YDS / TD / INT</div></div>
                            {% endif %}
                          </td>
                          <td class="tal"><div class="mockbox-player">{% if pa and pa.player %}{{ pa.player }}{% else %}—{% endif %}</div></td>
                          <td class="mockbox-num">{% if pa and pa.pass_yards is number %}{{ '%.0f' % pa.pass_yards }}{% else %}<span class="miss">—</span>{% endif %}</td>
                          <td class="mockbox-num">{% if pa and pa.pass_tds is number %}{{ '%.1f' % pa.pass_tds }}{% else %}<span class="miss">—</span>{% endif %}</td>
                          <td class="mockbox-num">{% if pa and pa.interceptions is number %}{{ '%.1f' % pa.interceptions }}{% else %}<span class="miss">—</span>{% endif %}</td>

                          <td class="tal"><div class="mockbox-player">{% if ph and ph.player %}{{ ph.player }}{% else %}—{% endif %}</div></td>
                          <td class="mockbox-num">{% if ph and ph.pass_yards is number %}{{ '%.0f' % ph.pass_yards }}{% else %}<span class="miss">—</span>{% endif %}</td>
                          <td class="mockbox-num">{% if ph and ph.pass_tds is number %}{{ '%.1f' % ph.pass_tds }}{% else %}<span class="miss">—</span>{% endif %}</td>
                          <td class="mockbox-num">{% if ph and ph.interceptions is number %}{{ '%.1f' % ph.interceptions }}{% else %}<span class="miss">—</span>{% endif %}</td>
                        </tr>
                      {% endfor %}

                      {# RUSH rows #}
                      {% set ar = (away.rushers if away and away.rushers else []) %}
                      {% set hr = (home.rushers if home and home.rushers else []) %}
                      {% set n_rush = (ar|length) if (ar|length) > (hr|length) else (hr|length) %}
                      {% if n_rush < 1 %}{% set n_rush = 1 %}{% endif %}
                      <tr class="mockbox-minihead">
                        <td></td><td></td>
                        <td class="tar">ATT</td><td class="tar">YDS</td><td class="tar">TD</td>
                        <td></td>
                        <td class="tar">ATT</td><td class="tar">YDS</td><td class="tar">TD</td>
                      </tr>
                      {% for i in range(n_rush) %}
                        {% set ra = ar[i] if i < (ar|length) else none %}
                        {% set rh = hr[i] if i < (hr|length) else none %}
                        <tr>
                          <td class="tal">
                            {% if i == 0 %}
                              <div class="mockbox-cat"><div class="k">RUSH</div><div class="s">ATT / YDS / TD</div></div>
                            {% endif %}
                          </td>
                          <td class="tal"><div class="mockbox-player">{% if ra and ra.player %}{{ ra.player }}{% else %}—{% endif %}</div></td>
                          <td class="mockbox-num">{% if ra and ra.rush_attempts is number %}{{ '%.1f' % ra.rush_attempts }}{% else %}<span class="miss">—</span>{% endif %}</td>
                          <td class="mockbox-num">{% if ra and ra.rush_yards is number %}{{ '%.0f' % ra.rush_yards }}{% else %}<span class="miss">—</span>{% endif %}</td>
                          <td class="mockbox-num">{% if ra and ra.rush_tds is number %}{{ '%.1f' % ra.rush_tds }}{% else %}<span class="miss">—</span>{% endif %}</td>

                          <td class="tal"><div class="mockbox-player">{% if rh and rh.player %}{{ rh.player }}{% else %}—{% endif %}</div></td>
                          <td class="mockbox-num">{% if rh and rh.rush_attempts is number %}{{ '%.1f' % rh.rush_attempts }}{% else %}<span class="miss">—</span>{% endif %}</td>
                          <td class="mockbox-num">{% if rh and rh.rush_yards is number %}{{ '%.0f' % rh.rush_yards }}{% else %}<span class="miss">—</span>{% endif %}</td>
                          <td class="mockbox-num">{% if rh and rh.rush_tds is number %}{{ '%.1f' % rh.rush_tds }}{% else %}<span class="miss">—</span>{% endif %}</td>
                        </tr>
                      {% endfor %}

                      {# REC rows #}
                      {% set ac = (away.receivers if away and away.receivers else []) %}
                      {% set hc = (home.receivers if home and home.receivers else []) %}
                      {% set n_rec = (ac|length) if (ac|length) > (hc|length) else (hc|length) %}
                      {% if n_rec < 1 %}{% set n_rec = 1 %}{% endif %}
                      <tr class="mockbox-minihead">
                        <td></td><td></td>
                        <td class="tar">REC</td><td class="tar">YDS</td><td class="tar">TD</td>
                        <td></td>
                        <td class="tar">REC</td><td class="tar">YDS</td><td class="tar">TD</td>
                      </tr>
                      {% for i in range(n_rec) %}
                        {% set ca = ac[i] if i < (ac|length) else none %}
                        {% set ch = hc[i] if i < (hc|length) else none %}
                        <tr>
                          <td class="tal">
                            {% if i == 0 %}
                              <div class="mockbox-cat"><div class="k">REC</div><div class="s">REC / YDS / TD</div></div>
                            {% endif %}
                          </td>
                          <td class="tal"><div class="mockbox-player">{% if ca and ca.player %}{{ ca.player }}{% else %}—{% endif %}</div></td>
                          <td class="mockbox-num">{% if ca and ca.receptions is number %}{{ '%.1f' % ca.receptions }}{% else %}<span class="miss">—</span>{% endif %}</td>
                          <td class="mockbox-num">{% if ca and ca.rec_yards is number %}{{ '%.0f' % ca.rec_yards }}{% else %}<span class="miss">—</span>{% endif %}</td>
                          <td class="mockbox-num">{% if ca and ca.rec_tds is number %}{{ '%.1f' % ca.rec_tds }}{% else %}<span class="miss">—</span>{% endif %}</td>

                          <td class="tal"><div class="mockbox-player">{% if ch and ch.player %}{{ ch.player }}{% else %}—{% endif %}</div></td>
                          <td class="mockbox-num">{% if ch and ch.receptions is number %}{{ '%.1f' % ch.receptions }}{% else %}<span class="miss">—</span>{% endif %}</td>
                          <td class="mockbox-num">{% if ch and ch.rec_yards is number %}{{ '%.0f' % ch.rec_yards }}{% else %}<span class="miss">—</span>{% endif %}</td>
                          <td class="mockbox-num">{% if ch and ch.rec_tds is number %}{{ '%.1f' % ch.rec_tds }}{% else %}<span class="miss">—</span>{% endif %}</td>
                        </tr>
                      {% endfor %}

                      {# DEF row (derived from sim drives) #}
                      {% set ad = (away.def if away and away.def else none) %}
                      {% set hd = (home.def if home and home.def else none) %}
                      <tr class="mockbox-minihead">
                        <td></td><td></td>
                        <td class="tar">TO</td><td class="tar">PUNTS</td><td class="tar">STOPS</td>
                        <td></td>
                        <td class="tar">TO</td><td class="tar">PUNTS</td><td class="tar">STOPS</td>
                      </tr>
                      <tr>
                        <td class="tal">
                          <div class="mockbox-cat"><div class="k">DEF</div><div class="s">TO / PUNTS / STOPS</div></div>
                        </td>
                        <td class="tal"><div class="mockbox-player">Defense</div></td>
                        <td class="mockbox-num">
                          {% if ad and ad.takeaways is number %}{{ '%.1f' % ad.takeaways }}{% else %}<span class="miss">—</span>{% endif %}
                          {% if ad and ad.ints is number and ad.fumbles is number %}
                            <span class="sub">INT {{ '%.1f' % ad.ints }} • FUM {{ '%.1f' % ad.fumbles }}{% if ad.downs is number %} • Downs {{ '%.1f' % ad.downs }}{% endif %}</span>
                          {% endif %}
                        </td>
                        <td class="mockbox-num">{% if ad and ad.punts_forced is number %}{{ '%.1f' % ad.punts_forced }}{% else %}<span class="miss">—</span>{% endif %}</td>
                        <td class="mockbox-num">{% if ad and ad.stop_rate is number %}{{ '%.0f' % (ad.stop_rate*100) }}%{% else %}<span class="miss">—</span>{% endif %}</td>

                        <td class="tal"><div class="mockbox-player">Defense</div></td>
                        <td class="mockbox-num">
                          {% if hd and hd.takeaways is number %}{{ '%.1f' % hd.takeaways }}{% else %}<span class="miss">—</span>{% endif %}
                          {% if hd and hd.ints is number and hd.fumbles is number %}
                            <span class="sub">INT {{ '%.1f' % hd.ints }} • FUM {{ '%.1f' % hd.fumbles }}{% if hd.downs is number %} • Downs {{ '%.1f' % hd.downs }}{% endif %}</span>
                          {% endif %}
                        </td>
                        <td class="mockbox-num">{% if hd and hd.punts_forced is number %}{{ '%.1f' % hd.punts_forced }}{% else %}<span class="miss">—</span>{% endif %}</td>
                        <td class="mockbox-num">{% if hd and hd.stop_rate is number %}{{ '%.0f' % (hd.stop_rate*100) }}%{% else %}<span class="miss">—</span>{% endif %}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="muted-small">No cached player-props found for this week/game.</div>
              {% endif %}
            </div>

            <div class="two-col">
              <div class="panel">
                <div class="section-title mt0">Top Props (Sim)</div>
                {% if g.sim_top_props %}
                  <div class="props props-compact props-table">
                    <div class="row head"><span>Player</span><span class="tar">Any TD</span></div>
                    {% for p in g.sim_top_props[:6] %}
                      {% set team_ab = none %}
                      {% if p.team and g.home_team and p.team == g.home_team %}{% set team_ab = g.home_abbr %}{% endif %}
                      {% if p.team and g.away_team and p.team == g.away_team %}{% set team_ab = g.away_abbr %}{% endif %}
                      <div class="row">
                        <span class="muted">
                          {% if team_ab %}<span class="pill">{{ team_ab }}</span>{% endif %}
                          {{ p.player }}{% if p.position %}&nbsp;<span class="muted-tiny">({{ p.position }})</span>{% endif %}
                          {% if p.team and not team_ab %}<span class="muted-tiny"> • {{ p.team }}</span>{% endif %}
                        </span>
                        <span class="val">{% if p.any_td_prob is number %}{{ '%.0f' % (p.any_td_prob*100) }}%{% else %}—{% endif %}</span>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="muted-small">No sim-based props available (missing player-props cache).</div>
                {% endif %}

                <div class="section-title">Market Props (Edges)</div>
                {% if g.top_prop_edges %}
                  <div class="props props-compact props-table">
                    <div class="row head"><span>Prop</span><span class="tar">Edge</span></div>
                    {% for p in g.top_prop_edges[:5] %}
                      {% set m = (p.market or p.market_key or '')
                        |replace('Passing Yards','Pass Yds')
                        |replace('Rushing Yards','Rush Yds')
                        |replace('Receiving Yards','Rec Yds')
                        |replace('Rush+Rec Yards','Rush+Rec')
                        |replace('Rushing Attempts','Rush Att')
                        |replace('Passing Attempts','Pass Att')
                      %}
                      {% set s = 'O' if p.side == 'Over' else ('U' if p.side == 'Under' else p.side) %}
                      <div class="row">
                        <span class="proptext">
                          <div class="l1">
                            {{ p.player }}{% if p.position %} <span class="muted-tiny">({{ p.position }})</span>{% endif %}
                            {% if s %} {{ s }}{% endif %}
                            {{ m }}{% if p.line is not none %} {{ '%.1f' % p.line }}{% endif %}
                            {% if p.is_ladder %}<span class="muted-tiny"> • Ladder</span>{% endif %}
                          </div>
                          <div class="l2">
                            {% if p.proj is not none %}proj {{ '%.1f' % p.proj }}{% endif %}
                            {% if p.price is not none %}{% if p.proj is not none %} · {% endif %}@ {{ '%+d' % p.price if p.price is number else p.price }}{% endif %}
                            {% if p.prob_edge is number %}{% if p.proj is not none or p.price is not none %} · {% endif %}pΔ {{ '%+.0f' % (p.prob_edge*100) }}pp{% endif %}
                          </div>
                        </span>
                        <span class="val">
                          {% if p.edge_side is number %}{{ '%+.1f' % p.edge_side }}
                          {% elif p.prob_edge is number %}{{ '%+.0f' % (p.prob_edge*100) }}pp
                          {% else %}—{% endif %}
                        </span>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="muted-small">No prop edges for this matchup.</div>
                {% endif %}
              </div>
            </div>

            <div class="chips">
              {% if g.prediction_source %}
                <span class="chip" title="Prediction source">Src {{ g.prediction_source }}</span>
              {% endif %}
              {% if g.weather_text %}
                <span class="chip">{{ g.weather_text }}</span>
              {% endif %}
              {% if g.stadium_roof %}
                <span class="chip">Roof {{ g.stadium_roof }}</span>
              {% endif %}
              {% if g.rest_text %}
                <span class="chip" title="Rest-days differential">{{ g.rest_text }}</span>
              {% endif %}
              {% if g.pressure_text %}
                <span class="chip" title="Combined defensive pressure">{{ g.pressure_text }}</span>
              {% endif %}
              {% if g.conf_method_ml or g.conf_method_ats or g.conf_method_total %}
                <span class="chip" title="Confidence EV source per market">
                  Conf
                  {% if g.conf_method_ml %} ML {{ g.conf_method_ml|capitalize }}{% endif %}
                  {% if g.conf_method_ats %}{% if g.conf_method_ml %} &middot;{% endif %} ATS {{ g.conf_method_ats|capitalize }}{% endif %}
                  {% if g.conf_method_total %}{% if g.conf_method_ml or g.conf_method_ats %} &middot;{% endif %} Tot {{ g.conf_method_total|capitalize }}{% endif %}
                </span>
              {% endif %}
              {% if g.injury_text %}
                <span class="chip" title="Injury starters summary">{{ g.injury_text }}</span>
              {% endif %}
              <span class="chip explain-toggle" role="button" tabindex="0">Show Explain</span>
              <span class="chip odds-toggle" role="button" tabindex="0">Show Odds</span>
              <span class="chip ratings-toggle" role="button" tabindex="0">Show Ratings</span>
            </div>

            <div class="ratings explain">
              <div class="row"><span class="muted">Model (raw): Home / Away / Margin / Total</span><span>
                {% set exm = g.explain.model if g.explain %}
                {% if exm and exm.home_points is number %}{{ '%.2f' % exm.home_points }}{% else %}-{% endif %}
                /
                {% if exm and exm.away_points is number %}{{ '%.2f' % exm.away_points }}{% else %}-{% endif %}
                /
                {% if exm and exm.margin is number %}{{ '%+.2f' % exm.margin }}{% else %}-{% endif %}
                /
                {% if exm and exm.total is number %}{{ '%.2f' % exm.total }}{% else %}-{% endif %}
              </span></div>
              <div class="row"><span class="muted">Blend: α(margin) / β(total) / apply-points</span><span>
                {% set exb = g.explain.blend if g.explain %}
                {% if exb and exb.alpha_margin is number %}{{ '%.2f' % exb.alpha_margin }}{% else %}-{% endif %}
                /
                {% if exb and exb.beta_total is number %}{{ '%.2f' % exb.beta_total }}{% else %}-{% endif %}
                /
                {% if exb and exb.apply_points is not none %}{{ exb.apply_points and 'on' or 'off' }}{% else %}-{% endif %}
              </span></div>
              <div class="row"><span class="muted">Blended: Home / Away / Margin / Total</span><span>
                {% if exb and exb.home_points_final is number %}{{ '%.2f' % exb.home_points_final }}{% else %}-{% endif %}
                /
                {% if exb and exb.away_points_final is number %}{{ '%.2f' % exb.away_points_final }}{% else %}-{% endif %}
                /
                {% if exb and exb.margin_final is number %}{{ '%+.2f' % exb.margin_final }}{% else %}-{% endif %}
                /
                {% if exb and exb.total_final is number %}{{ '%.2f' % exb.total_final }}{% else %}-{% endif %}
              </span></div>
            </div>

            <div class="odds">
              <div class="row"><span class="muted">Implied Win Prob (Away / Home)</span><span>
                {% if g.implied_away_prob is number %}{{ '%.1f' % (g.implied_away_prob*100) }}%{% else %}-{% endif %}
                /
                {% if g.implied_home_prob is number %}{{ '%.1f' % (g.implied_home_prob*100) }}%{% else %}-{% endif %}
              </span></div>
            </div>
            
            <div class="ratings">
              <div class="row"><span class="muted">Off PPG (Away / Home)</span><span>
                {% if g.away_off_ppg is number %}{{ '%.1f' % g.away_off_ppg }}{% else %}-{% endif %}
                /
                {% if g.home_off_ppg is number %}{{ '%.1f' % g.home_off_ppg }}{% else %}-{% endif %}
              </span></div>
              <div class="row"><span class="muted">Def PPG (Away / Home)</span><span>
                {% if g.away_def_ppg is number %}{{ '%.1f' % g.away_def_ppg }}{% else %}-{% endif %}
                /
                {% if g.home_def_ppg is number %}{{ '%.1f' % g.home_def_ppg }}{% else %}-{% endif %}
              </span></div>
              <div class="row"><span class="muted">Net Margin (Away / Home)</span><span>
                {% if g.away_net_margin is number %}{{ '%.1f' % g.away_net_margin }}{% else %}-{% endif %}
                /
                {% if g.home_net_margin is number %}{{ '%.1f' % g.home_net_margin }}{% else %}-{% endif %}
              </span></div>
              <div class="row"><span class="muted">Diffs (Off / Def / Net)</span><span>
                {% if g.off_ppg_diff is number %}{{ '%+.1f' % g.off_ppg_diff }}{% else %}-{% endif %}
                /
                {% if g.def_ppg_diff is number %}{{ '%+.1f' % g.def_ppg_diff }}{% else %}-{% endif %}
                /
                {% if g.net_margin_diff is number %}{{ '%+.1f' % g.net_margin_diff }}{% else %}-{% endif %}
              </span></div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p>No predictions found. Generate predictions locally, then deploy: python -m nfl_compare.src.predict</p>
    {% endif %}

    <p class="mt-16 fs-13">
      API: <a href="/api/predictions">/api/predictions</a> | <a href="/health">/health</a>
    </p>
    {% include '_footer.html' %}
  </div>
  <script>
    (function(){
      try {
        // Theme: restore preference and wire toggle
        var body = document.body;
        var saved = localStorage.getItem('theme');
        if (saved === 'light') { body.classList.add('light'); }
        var tbtn = document.getElementById('themeToggle');
        if (tbtn) {
          tbtn.addEventListener('click', function(){
            body.classList.toggle('light');
            localStorage.setItem('theme', body.classList.contains('light') ? 'light' : 'dark');
            // Re-evaluate dynamic colors on theme change
            applyTeamColors();
          });
        }
        function parseColor(str){
          if(!str) return null;
          str = (''+str).trim();
          if(str.startsWith('var(')){
            // resolve CSS var
            var name = str.slice(4,-1).trim();
            var v = getComputedStyle(document.body).getPropertyValue(name).trim();
            return parseColor(v);
          }
          if(str.startsWith('#')){
            let hex = str.slice(1);
            if(hex.length===3) hex = hex.split('').map(x=>x+x).join('');
            var num = parseInt(hex,16);
            return {r:(num>>16)&255,g:(num>>8)&255,b:num&255};
          }
          if(str.startsWith('rgb')){
            var m = str.match(/rgba?\(([^\)]+)\)/);
            if(m){
              var parts = m[1].split(',').map(s=>parseFloat(s.trim()));
              return {r:parts[0],g:parts[1],b:parts[2]};
            }
          }
          return null;
        }
        function relLum(rgb){
          function srgbToLin(c){ c/=255; return c<=0.03928? c/12.92 : Math.pow((c+0.055)/1.055,2.4); }
          var r = srgbToLin(rgb.r), g = srgbToLin(rgb.g), b = srgbToLin(rgb.b);
          return 0.2126*r + 0.7152*g + 0.0722*b;
        }
        function contrast(c1,c2){
          var L1 = relLum(c1), L2 = relLum(c2);
          var lighter = Math.max(L1,L2), darker = Math.min(L1,L2);
          return (lighter + 0.05) / (darker + 0.05);
        }
        function mix(rgb1, rgb2, t){ // linear mix 0..1
          return {r:Math.round(rgb1.r*(1-t)+rgb2.r*t), g:Math.round(rgb1.g*(1-t)+rgb2.g*t), b:Math.round(rgb1.b*(1-t)+rgb2.b*t)};
        }
        function toHex(rgb){
          const h = (n)=>('0'+n.toString(16)).slice(-2);
          return '#'+h(rgb.r)+h(rgb.g)+h(rgb.b);
        }
  function applyTeamColors(){
          var bgVar = getComputedStyle(document.body).getPropertyValue('--card2').trim() || getComputedStyle(document.body).getPropertyValue('--bg').trim();
          var bg = parseColor(bgVar) || {r:18,g:27,b:49};
          var themeTextVar = getComputedStyle(document.body).getPropertyValue('--text').trim();
          var themeText = parseColor(themeTextVar) || {r:245,g:247,b:255};
          document.querySelectorAll('.dynamic-color').forEach(function(el){
            var c1s = el.getAttribute('data-color');
            var c2s = el.getAttribute('data-color2');
            var c1 = parseColor(c1s);
            var c2 = parseColor(c2s);
            var chosen = null;
            var threshold = 4.5; // WCAG AA for normal text
            // Try primary
            if (c1 && contrast(c1,bg) >= threshold) chosen = c1;
            // Then secondary
            if (!chosen && c2 && contrast(c2,bg) >= threshold) chosen = c2;
            // Then theme text
            if (!chosen && themeText && contrast(themeText,bg) >= threshold) chosen = themeText;
            // Else blend toward theme text to reach threshold up to 80%
            if (!chosen && c1){
              var t=0, step=0.1, cur=c1;
              while(t<=0.8 && contrast(cur,bg) < threshold){ t+=step; cur = mix(c1, themeText, t); }
              chosen = cur;
            }
            if (!chosen) chosen = themeText;
            el.style.color = toHex(chosen);
          });
        }
        applyTeamColors();
        // Odds toggle handlers
        var cards = document.querySelectorAll('.card');
        var isMobile = window.matchMedia('(max-width: 760px)').matches;
        document.querySelectorAll('.card').forEach(function(card){
          // Explain toggle per-card
          var etoggle = card.querySelector('.explain-toggle');
          var epanel = card.querySelector('.explain');
          if (etoggle && epanel){
            function eflip(){
              var isOpen = epanel.style.display === 'block';
              epanel.style.display = isOpen ? 'none' : 'block';
              etoggle.textContent = isOpen ? 'Show Explain' : 'Hide Explain';
              updateGlobalRatingsButton();
            }
            etoggle.addEventListener('click', eflip);
            etoggle.addEventListener('keypress', function(e){ if (e.key==='Enter' || e.key===' ') { e.preventDefault(); eflip(); }});
            // Default collapsed
            epanel.style.display = 'none';
            etoggle.textContent = 'Show Explain';
          }
          var toggle = card.querySelector('.odds-toggle');
          var panel = card.querySelector('.odds');
          if (toggle && panel){
            function flip(){
              var isOpen = panel.style.display === 'block';
              panel.style.display = isOpen ? 'none' : 'block';
              toggle.textContent = isOpen ? 'Show Odds' : 'Hide Odds';
              updateGlobalOddsButton();
            }
            toggle.addEventListener('click', flip);
            toggle.addEventListener('keypress', function(e){ if (e.key==='Enter' || e.key===' ') { e.preventDefault(); flip(); }});
            // Default collapsed on mobile for space, expanded on desktop (unless user stored preference)
            var stored = localStorage.getItem('oddsAllOpen');
            if(stored === null){
              if(isMobile){
                panel.style.display = 'none';
                toggle.textContent = 'Show Odds';
              } else {
                panel.style.display = 'block';
                toggle.textContent = 'Hide Odds';
              }
            } else {
              // will be managed by global restore later
            }
          }

          // Ratings toggle per-card
          var rtoggle = card.querySelector('.ratings-toggle');
          var rpanel = card.querySelector('.ratings');
          if (rtoggle && rpanel){
            function rflip(){
              var isOpen = rpanel.style.display === 'block';
              rpanel.style.display = isOpen ? 'none' : 'block';
              rtoggle.textContent = isOpen ? 'Show Ratings' : 'Hide Ratings';
              updateGlobalRatingsButton();
            }
            rtoggle.addEventListener('click', rflip);
            rtoggle.addEventListener('keypress', function(e){ if (e.key==='Enter' || e.key===' ') { e.preventDefault(); rflip(); }});
            var rstored = localStorage.getItem('ratingsAllOpen');
            if(rstored === null){
              if(isMobile){
                rpanel.style.display = 'none';
                rtoggle.textContent = 'Show Ratings';
              } else {
                rpanel.style.display = 'block';
                rtoggle.textContent = 'Hide Ratings';
              }
            } else {
              // managed by global restore later
            }
          }
        });
        function allOddsOpen(){
          return Array.from(document.querySelectorAll('.card .odds')).every(p=>p.style.display==='block');
        }
        function anyOddsOpen(){
          return Array.from(document.querySelectorAll('.card .odds')).some(p=>p.style.display==='block');
        }
        function setAllOdds(open){
          document.querySelectorAll('.card').forEach(function(card){
            var panel = card.querySelector('.odds');
            var toggle = card.querySelector('.odds-toggle');
            if(panel && toggle){
              panel.style.display = open ? 'block' : 'none';
              toggle.textContent = open ? 'Hide Odds' : 'Show Odds';
            }
          });
          localStorage.setItem('oddsAllOpen', open ? '1' : '0');
          updateGlobalOddsButton();
        }
        function updateGlobalOddsButton(){
          var btn = document.getElementById('toggleAllOdds');
          if(!btn) return;
          if (allOddsOpen()) btn.textContent = 'Hide All Odds'; else if (anyOddsOpen()) btn.textContent = 'Show All Odds'; else btn.textContent = 'Show All Odds';
        }
  var globalBtn = document.getElementById('toggleAllOdds');
        if(globalBtn){
          globalBtn.addEventListener('click', function(){
            var open = !allOddsOpen();
            setAllOdds(open);
          });
          // Restore persisted preference if exists
          var stored = localStorage.getItem('oddsAllOpen');
          if(stored === '0'){
            setAllOdds(false);
          } else {
            // If no stored preference and mobile, ensure collapsed; otherwise update
            if(stored === null && isMobile){
              setAllOdds(false);
            } else {
              updateGlobalOddsButton();
            }
          }
        }

        // Ratings global helpers and handlers
        function allRatingsOpen(){
          return Array.from(document.querySelectorAll('.card .ratings')).every(p=>p.style.display==='block');
        }
        function anyRatingsOpen(){
          return Array.from(document.querySelectorAll('.card .ratings')).some(p=>p.style.display==='block');
        }
        function setAllRatings(open){
          document.querySelectorAll('.card').forEach(function(card){
            var panel = card.querySelector('.ratings');
            var toggle = card.querySelector('.ratings-toggle');
            if(panel && toggle){
              panel.style.display = open ? 'block' : 'none';
              toggle.textContent = open ? 'Hide Ratings' : 'Show Ratings';
            }
          });
          localStorage.setItem('ratingsAllOpen', open ? '1' : '0');
          updateGlobalRatingsButton();
        }
        function updateGlobalRatingsButton(){
          var btn = document.getElementById('toggleAllRatings');
          if(!btn) return;
          if (allRatingsOpen()) btn.textContent = 'Hide All Ratings'; else if (anyRatingsOpen()) btn.textContent = 'Show All Ratings'; else btn.textContent = 'Show All Ratings';
        }
        var globalBtnR = document.getElementById('toggleAllRatings');
        if(globalBtnR){
          globalBtnR.addEventListener('click', function(){
            var open = !allRatingsOpen();
            setAllRatings(open);
          });
          var rstored = localStorage.getItem('ratingsAllOpen');
          if(rstored === '0'){
            setAllRatings(false);
          } else {
            if(rstored === null && isMobile){
              setAllRatings(false);
            } else {
              updateGlobalRatingsButton();
            }
          }
        }

        // Admin: run daily update button (prompts for key)
    var adminBtn = document.getElementById('adminRunDU');
        if (adminBtn){
          adminBtn.addEventListener('click', async function(){
            try{
              var key = localStorage.getItem('adminKey') || prompt('Admin key?');
              if(!key){ return; }
              localStorage.setItem('adminKey', key);
              // Start job
      let res = await fetch(window.location.origin + '/api/admin/daily-update?push=1&key=' + encodeURIComponent(key), {method:'POST'});
              if(res.status===401){ alert('Unauthorized. Wrong key.'); return; }
              if(res.ok || res.status===202){
                alert('Daily update started. A log panel will open.');
                // Open minimal status viewer
                openLogViewer(key);
              } else {
                let t = await res.text();
                alert('Failed to start: '+ t);
              }
            }catch(e){ alert('Error: '+ e); }
          });

          function openLogViewer(key){
            var w = window.open('', 'du_status', 'width=720,height=540');
            if(!w){ alert('Allow pop-ups to view status.'); return; }
            w.document.write('<html><head><title>Daily Update – Status</title><style>body{font-family:system-ui;background:#0d1426;color:#f5f7ff;margin:0} .hdr{padding:8px 12px;border-bottom:1px solid #243356;background:#121b31} .logs{padding:12px;white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;font-size:12px} button{background:#1b2339;border:1px solid #2a3a63;border-radius:6px;color:#e6edf7;padding:6px 10px;margin-right:8px;cursor:pointer}</style></head><body><div class="hdr"><button id="refresh">Refresh</button><span id="state">Loading…</span></div><div class="logs" id="logs"></div></body></html>');
            try { w.document.close(); } catch (e) { /* ignore */ }

            // Base origin from opener to avoid about:blank relative URL issues
            var baseOrigin = (function(){
              try{ return (window.opener && window.opener.location && window.opener.location.origin) ? window.opener.location.origin : window.location.origin; }catch(e){ return window.location.origin; }
            })();

            async function refresh(){
              try{
                let url = baseOrigin + '/api/admin/daily-update/status?tail=400&key='+ encodeURIComponent(key);
                let res = await fetch(url);
                var stateEl = w.document.getElementById('state');
                var logsEl = w.document.getElementById('logs');
                if(!stateEl || !logsEl){ setTimeout(refresh, 500); return; }
                if(res.status===401){ stateEl.textContent = 'Unauthorized (bad or missing admin key)'; return; }
                if(!res.ok){ stateEl.textContent = 'Error '+res.status+': '+(await res.text()).slice(0,200); setTimeout(refresh, 3000); return; }
                let j = await res.json();
                stateEl.textContent = (j.running? 'Running' : (j.ok===true?'OK': j.ok===false?'Failed':'Idle')) + (j.started_at? ' • started '+ j.started_at: '') + (j.ended_at? ' • ended '+ j.ended_at : '');
                logsEl.textContent = (j.logs||[]).join('\n');
                // Auto-poll while running
                if(j.running){ setTimeout(refresh, 2500); }
              }catch(e){
                try{ w.document.getElementById('state').textContent = 'Error fetching status; retrying…'; }catch(_){/*no-op*/}
                setTimeout(refresh, 3000);
              }
            }

            // Initialize immediately when DOM is ready in the popup
            (function init(){
              try{
                var btn = w.document.getElementById('refresh');
                if(!btn){ setTimeout(init, 100); return; }
                btn.addEventListener('click', refresh);
                refresh();
              }catch(e){ setTimeout(init, 150); }
            })();
          }
        }

        // Inline admin panel
        (function(){
          var panelBtn = document.getElementById('adminToggle');
          var panel = document.getElementById('adminPanel');
          var keyInput = document.getElementById('adminKeyInput');
          var startBtn = document.getElementById('adminStart');
          var pushToggle = document.getElementById('adminPushToggle');
          var stateEl = document.getElementById('adminState');
          var logsEl = document.getElementById('adminLogs');
          var polling = false;
          function getKey(){
            var v = keyInput.value || localStorage.getItem('adminKey') || '';
            if(!keyInput.value && v){ keyInput.value = v; }
            return v;
          }
          async function poll(){
            if(!panel || panel.style.display==='none'){ polling=false; return; }
            try{
              var key = getKey();
              if(!key){ stateEl.textContent = 'Enter ADMIN_KEY to view status'; setTimeout(poll, 3000); return; }
              var res = await fetch('/api/admin/daily-update/status?tail=400&key='+ encodeURIComponent(key));
              if(res.status===401){ stateEl.textContent = 'Unauthorized (bad or missing key)'; setTimeout(poll, 3000); return; }
              if(!res.ok){ stateEl.textContent = 'Error '+res.status; setTimeout(poll, 3000); return; }
              var j = await res.json();
              stateEl.textContent = (j.running? 'Running' : (j.ok===true?'OK': j.ok===false?'Failed':'Idle')) + (j.started_at? ' • started '+ j.started_at: '') + (j.ended_at? ' • ended '+ j.ended_at : '');
              logsEl.textContent = (j.logs||[]).join('\n');
              if(j.running){ setTimeout(poll, 2500); } else { setTimeout(poll, 5000); }
            }catch(e){ stateEl.textContent = 'Network error; retrying…'; setTimeout(poll, 3000); }
          }
          if(panelBtn){
            panelBtn.addEventListener('click', function(){
              var open = panel.style.display !== 'none';
              panel.style.display = open ? 'none' : 'block';
              if(!open && !polling){ polling = true; setTimeout(poll, 200); }
            });
          }
          if(startBtn){
            startBtn.addEventListener('click', async function(){
              var key = getKey();
              if(!key){ alert('Enter ADMIN_KEY first.'); return; }
              localStorage.setItem('adminKey', key);
              try{
                stateEl.textContent = 'Starting…';
                var push = (pushToggle && pushToggle.checked) ? '1' : '0';
                var res = await fetch('/api/admin/daily-update?push='+ push +'&key='+ encodeURIComponent(key), {method:'POST'});
                if(res.status===401){ stateEl.textContent = 'Unauthorized (bad key)'; return; }
                if(res.ok || res.status===202){ stateEl.textContent = 'Started…'; poll(); return; }
                // fallback to GET in case some environments block POST
                var res2 = await fetch('/api/admin/daily-update?push='+ push +'&key='+ encodeURIComponent(key));
                if(res2.ok || res2.status===202){ stateEl.textContent = 'Started…'; poll(); return; }
                stateEl.textContent = 'Failed to start ('+ res.status +')';
              }catch(e){ stateEl.textContent = 'Network error starting job'; }
            });
          }
        })();
      } catch (e) { /* no-op */ }
    })();
  </script>
</body>
</html>
